"use strict";(self.webpackChunkawesome_notes=self.webpackChunkawesome_notes||[]).push([[1170],{3905:function(e,n,t){t.d(n,{Zo:function(){return c},kt:function(){return d}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=a.createContext({}),p=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},c=function(e){var n=p(e.components);return a.createElement(s.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),m=p(t),d=r,k=m["".concat(s,".").concat(d)]||m[d]||u[d]||l;return t?a.createElement(k,i(i({ref:n},c),{},{components:t})):a.createElement(k,i({ref:n},c))}));function d(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,i=new Array(l);i[0]=m;var o={};for(var s in n)hasOwnProperty.call(n,s)&&(o[s]=n[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var p=2;p<l;p++)i[p]=t[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},3113:function(e,n,t){t.r(n),t.d(n,{assets:function(){return c},contentTitle:function(){return s},default:function(){return d},frontMatter:function(){return o},metadata:function(){return p},toc:function(){return u}});var a=t(7462),r=t(3366),l=(t(7294),t(3905)),i=["components"],o={author:"Sabertazimi",authorTitle:"Web Developer",authorURL:"https://github.com/sabertazimi",authorImageURL:"https://github.com/sabertazimi.png",tags:["Web","Node"]},s="Node Basic Notes",p={unversionedId:"web/node/nodeBasicNotes",id:"web/node/nodeBasicNotes",title:"Node Basic Notes",description:"Node App Structure",source:"@site/notes/web/node/nodeBasicNotes.md",sourceDirName:"web/node",slug:"/web/node/nodeBasicNotes",permalink:"/awesome-notes/web/node/nodeBasicNotes",editUrl:"https://github.com/sabertazimi/awesome-notes/edit/main/notes/web/node/nodeBasicNotes.md",tags:[{label:"Web",permalink:"/awesome-notes/tags/web"},{label:"Node",permalink:"/awesome-notes/tags/node"}],version:"current",lastUpdatedBy:"sabertazimi",lastUpdatedAt:1650611162,formattedLastUpdatedAt:"4/22/2022",frontMatter:{author:"Sabertazimi",authorTitle:"Web Developer",authorURL:"https://github.com/sabertazimi",authorImageURL:"https://github.com/sabertazimi.png",tags:["Web","Node"]},sidebar:"sidebar",previous:{title:"Message Queue Basic Notes",permalink:"/awesome-notes/web/node/messageQueueBasicNotes"},next:{title:"React Basic Notes",permalink:"/awesome-notes/web/react/reactBasicNotes"}},c={},u=[{value:"Node App Structure",id:"node-app-structure",level:2},{value:"NPM CLI",id:"npm-cli",level:2},{value:"NPM Mirrors",id:"npm-mirrors",level:3},{value:"Node Version Manager",id:"node-version-manager",level:3},{value:"Basic Steps",id:"basic-steps",level:3},{value:"Test Steps",id:"test-steps",level:3},{value:"Publish Steps",id:"publish-steps",level:3},{value:"Semantic Version",id:"semantic-version",level:3},{value:"Tab Completion",id:"tab-completion",level:3},{value:"Basic Command",id:"basic-command",level:3},{value:"Link Command",id:"link-command",level:3},{value:"Security Command",id:"security-command",level:3},{value:"NPX Command",id:"npx-command",level:3},{value:"NPM Dependencies",id:"npm-dependencies",level:3},{value:"NPM Doppelgangers",id:"npm-doppelgangers",level:4},{value:"NPM Ghost Dependency",id:"npm-ghost-dependency",level:4},{value:"NPM Invalid Dependency",id:"npm-invalid-dependency",level:4},{value:"Package JSON",id:"package-json",level:3},{value:"Bin",id:"bin",level:4},{value:"Version",id:"version",level:4},{value:"NPM Workspaces",id:"npm-workspaces",level:4},{value:"Exports Field",id:"exports-field",level:4},{value:"Package Lockfile",id:"package-lockfile",level:3},{value:"CLI Environment",id:"cli-environment",level:3},{value:"Corepack",id:"corepack",level:3},{value:"Yarn",id:"yarn",level:2},{value:"Yarn Configuration",id:"yarn-configuration",level:3},{value:"Yarn Updates",id:"yarn-updates",level:3},{value:"Yarn Workspace",id:"yarn-workspace",level:3},{value:"Yarn Plugin",id:"yarn-plugin",level:3},{value:"Yarn Patch",id:"yarn-patch",level:3},{value:"Yarn Berry Read World Case",id:"yarn-berry-read-world-case",level:3},{value:"Self-Defined Module",id:"self-defined-module",level:2},{value:"Basic Modular Pattern",id:"basic-modular-pattern",level:3},{value:"Export Module",id:"export-module",level:3},{value:"CallBack Function",id:"callback-function",level:3},{value:"Module Resolution",id:"module-resolution",level:3},{value:"Node Module",id:"node-module",level:2},{value:"CommonJS Module",id:"commonjs-module",level:3},{value:"EcmaScript Module",id:"ecmascript-module",level:3},{value:"Process Module",id:"process-module",level:2},{value:"Process Properties",id:"process-properties",level:3},{value:"Process Events",id:"process-events",level:3},{value:"Process Information",id:"process-information",level:3},{value:"Process Event Loop and Counter",id:"process-event-loop-and-counter",level:3},{value:"Child Process",id:"child-process",level:3},{value:"Worker Threads Module",id:"worker-threads-module",level:2},{value:"File Module",id:"file-module",level:2},{value:"FS API",id:"fs-api",level:3},{value:"Buffer Object",id:"buffer-object",level:3},{value:"Path API",id:"path-api",level:3},{value:"Http Module",id:"http-module",level:2},{value:"Request Object",id:"request-object",level:3},{value:"\u5c5e\u6027",id:"\u5c5e\u6027",level:4},{value:"Response Object",id:"response-object",level:3},{value:"\u7c7b\u578b",id:"\u7c7b\u578b",level:4},{value:"\u4e8b\u4ef6",id:"\u4e8b\u4ef6",level:4},{value:"\u65b9\u6cd5",id:"\u65b9\u6cd5",level:4},{value:"Http Get",id:"http-get",level:3},{value:"Http Server",id:"http-server",level:3},{value:"Sample",id:"sample",level:3},{value:"Net Module",id:"net-module",level:2},{value:"Socket Object",id:"socket-object",level:3},{value:"Socket IO",id:"socket-io",level:3},{value:"Basic Methods",id:"basic-methods",level:3},{value:"URL Module",id:"url-module",level:2},{value:"Basic Method",id:"basic-method",level:3},{value:"parse",id:"parse",level:4},{value:"dns",id:"dns",level:3},{value:"Security Module",id:"security-module",level:2},{value:"Crypto",id:"crypto",level:3},{value:"Hash API",id:"hash-api",level:4},{value:"HMAC API",id:"hmac-api",level:4},{value:"\u516c\u94a5\u52a0\u5bc6",id:"\u516c\u94a5\u52a0\u5bc6",level:4},{value:"Async Modules",id:"async-modules",level:2},{value:"Cluster Module",id:"cluster-module",level:3},{value:"Test Module",id:"test-module",level:2},{value:"Assert Module",id:"assert-module",level:3},{value:"Node Web Crawler",id:"node-web-crawler",level:2},{value:"Node Reference",id:"node-reference",level:2}],m={toc:u};function d(e){var n=e.components,t=(0,r.Z)(e,i);return(0,l.kt)("wrapper",(0,a.Z)({},m,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"node-basic-notes"},"Node Basic Notes"),(0,l.kt)("h2",{id:"node-app-structure"},"Node App Structure"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Main ./index.js, ./server.js, or ./yourEntryFile.js in the root"),(0,l.kt)("li",{parentName:"ul"},"Supporting files in ./lib/"),(0,l.kt)("li",{parentName:"ul"},"Static HTTP files in ./public/"),(0,l.kt)("li",{parentName:"ul"},"Views or templates in ./views/"),(0,l.kt)("li",{parentName:"ul"},"Command-line executables in ./bin/"),(0,l.kt)("li",{parentName:"ul"},"Tests in ./test/ (or ./spec/ if you\u2019re a Jasmine cool-aid drinker)"),(0,l.kt)("li",{parentName:"ul"},"npm scripts in ./scripts/"),(0,l.kt)("li",{parentName:"ul"},"Config in ./config/"),(0,l.kt)("li",{parentName:"ul"},"Documentation in ./doc/"),(0,l.kt)("li",{parentName:"ul"},"Examples in ./examples/"),(0,l.kt)("li",{parentName:"ul"},"Performance analysis in ./benchmarks/"),(0,l.kt)("li",{parentName:"ul"},"Native C/C++ source in ./source/")),(0,l.kt)("h2",{id:"npm-cli"},"NPM CLI"),(0,l.kt)("h3",{id:"npm-mirrors"},"NPM Mirrors"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://github.com/cnpm/binary-mirror-config"},"NPM mirror list"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npm config set disturl https://npmmirror.com/mirrors/node/\nnpm config set chromedriver_cdnurl http://npmmirror.com/mirrors/chromedriver/\nnpm config set electron_mirror https://npmmirror.com/mirrors/electron/\nnpm config set electron_builder_binaries_mirror https://npmmirror.com/mirrors/electron-builder-binaries/\nnpm config set operadriver_cdnurl http://npmmirror.com/mirrors/operadriver/\nnpm config set phantomjs_cdnurl https://npmmirror.com/mirrors/phantomjs/\nnpm config set profiler_binary_host_mirror http://npmmirror.com/mirrors/node-inspector/\nnpm config set puppeteer_download_host https://npmmirror.com/mirrors/\nnpm config set python_mirror https://npmmirror.com/mirrors/python/\nnpm config set robotjs_binary_host https://npmmirror.com/mirrors/robotjs/\nnpm config set sass_binary_site https://npmmirror.com/mirrors/node-sass/\nnpm config set saucectl_install_binary_mirror https://npmmirror.com/mirrors/saucectl/\nnpm config set sentrycli_cdnurl https://npmmirror.com/mirrors/sentry-cli/\nnpm config set sharp_binary_host https://npmmirror.com/mirrors/sharp/\nnpm config set sharp_libvips_binary_host https://npmmirror.com/mirrors/sharp-libvips/\nnpm config set sqlite3_binary_site https://npmmirror.com/mirrors/sqlite3/\nnpm config set swc_binary_site https://npmmirror.com/mirrors/node-swc/\n")),(0,l.kt)("h3",{id:"node-version-manager"},"Node Version Manager"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/nvm-sh/nvm"},"NVM"),".")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash\nwget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# Install and use the latest version\nnvm install node\nnvm use node\nnvm alias default node\n\n# Install and use the latest LTS version\nnvm install --lts\nnvm use --lts\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# Install and use specific version\nnvm install 16\nnvm use 16\nnvm ls\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# Update to latest version\nnvm install 16\nnvm install node\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# Remove version\nnvm uninstall 14\nnvm uninstall 12\n")),(0,l.kt)("h3",{id:"basic-steps"},"Basic Steps"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npm adduser\nmkdir proj/\n# \u4fee\u6539 package.json \u53ef\u518d\u6b21\u8fd0\u884c\u6b64\u547d\u4ee4\n# scope for everyone\nnpm init --scope=<username>\n\n# \u4fee\u6539 package.json \u53ef\u518d\u6b21\u8fd0\u884c\u6b64\u547d\u4ee4(\u4e0d\u63a5\u6a21\u5757\u540d\u4e3a\u81ea\u52a8\u66f4\u65b0)\nnpm install -S <package>\nnpm install -D <package>\nnpm prune      # \u6e05\u9664\u65e0\u7528\u5305\nnpm rm --save  # --save \u5220\u9664\u6587\u4ef6\u7684\u540c\u65f6\u66f4\u65b0 package.json \u6587\u4ef6\n\nnpm ls\nnpm outdated   # \u53bb\u9664\u8fc7\u671f\u5305\n")),(0,l.kt)("h3",{id:"test-steps"},"Test Steps"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "scripts": {\n    "test": "node test.js"\n  }\n}\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npm test\n")),(0,l.kt)("h3",{id:"publish-steps"},"Publish Steps"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"latest")," or ",(0,l.kt)("inlineCode",{parentName:"p"},"alpha"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npm publish\nnpm publish --tag [<tag>]\nnpm dist-tag add <pkg>@<version> [<tag>]\nnpm dist-tag rm <pkg> <tag>\nnpm dist-tag ls [<pkg>]\n")),(0,l.kt)("p",null,"NPM registry token configuration:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npm config set @orgName:registry https://registry.example.com\nnpm config set //registry.example.com/:_authToken XXXXXTokenXXXXX\n")),(0,l.kt)("p",null,"Release script from VitePress:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const fs = require('fs');\nconst path = require('path');\nconst chalk = require('chalk');\nconst semver = require('semver');\nconst { prompt } = require('enquirer');\nconst execa = require('execa');\nconst currentVersion = require('../package.json').version;\n\nconst versionIncrements = ['patch', 'minor', 'major'];\n\nconst inc = i => semver.inc(currentVersion, i);\nconst bin = name => path.resolve(__dirname, `../node_modules/.bin/${name}`);\nconst run = (bin, args, opts = {}) =>\n  execa(bin, args, { stdio: 'inherit', ...opts });\nconst step = msg => console.log(chalk.cyan(msg));\n\nasync function main() {\n  let targetVersion;\n\n  const { release } = await prompt({\n    type: 'select',\n    name: 'release',\n    message: 'Select release type',\n    choices: versionIncrements.map(i => `${i} (${inc(i)})`).concat(['custom']),\n  });\n\n  if (release === 'custom') {\n    targetVersion = (\n      await prompt({\n        type: 'input',\n        name: 'version',\n        message: 'Input custom version',\n        initial: currentVersion,\n      })\n    ).version;\n  } else {\n    targetVersion = release.match(/\\((.*)\\)/)[1];\n  }\n\n  if (!semver.valid(targetVersion)) {\n    throw new Error(`Invalid target version: ${targetVersion}`);\n  }\n\n  const { yes: tagOk } = await prompt({\n    type: 'confirm',\n    name: 'yes',\n    message: `Releasing v${targetVersion}. Confirm?`,\n  });\n\n  if (!tagOk) {\n    return;\n  }\n\n  // Update the package version.\n  step('\\nUpdating the package version...');\n  updatePackage(targetVersion);\n\n  // Build the package.\n  step('\\nBuilding the package...');\n  await run('yarn', ['build']);\n\n  // Generate the changelog.\n  step('\\nGenerating the changelog...');\n  await run('yarn', ['changelog']);\n  await run('yarn', ['prettier', '--write', 'CHANGELOG.md']);\n\n  const { yes: changelogOk } = await prompt({\n    type: 'confirm',\n    name: 'yes',\n    message: `Changelog generated. Does it look good?`,\n  });\n\n  if (!changelogOk) {\n    return;\n  }\n\n  // Commit changes to the Git and create a tag.\n  step('\\nCommitting changes...');\n  await run('git', ['add', 'CHANGELOG.md', 'package.json']);\n  await run('git', ['commit', '-m', `release: v${targetVersion}`]);\n  await run('git', ['tag', `v${targetVersion}`]);\n\n  // Publish the package.\n  step('\\nPublishing the package...');\n  await run('yarn', [\n    'publish',\n    '--new-version',\n    targetVersion,\n    '--no-commit-hooks',\n    '--no-git-tag-version',\n  ]);\n  await run('npm', [\n    'publish',\n    '--registry',\n    'https://registry.npmjs.org',\n    '--access',\n    'public',\n  ]);\n\n  // Push to GitHub.\n  step('\\nPushing to GitHub...');\n  await run('git', ['push', 'origin', `refs/tags/v${targetVersion}`]);\n  await run('git', ['push']);\n}\n\nfunction updatePackage(version) {\n  const pkgPath = path.resolve(path.resolve(__dirname, '..'), 'package.json');\n  const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf-8'));\n\n  pkg.version = version;\n\n  fs.writeFileSync(pkgPath, `${JSON.stringify(pkg, null, 2)}\\n`);\n}\n\nmain().catch(err => console.error(err));\n")),(0,l.kt)("h3",{id:"semantic-version"},"Semantic Version"),(0,l.kt)("p",null,"Semver:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Patch release: bugfix and other minor changes."),(0,l.kt)("li",{parentName:"ul"},"Minor release: new features not breaking API (backward compatible)."),(0,l.kt)("li",{parentName:"ul"},"Major release: new features breaking API (not backward compatible)."),(0,l.kt)("li",{parentName:"ul"},"Alpha (\u03b1): \u9884\u89c8\u7248 (\u5185\u90e8\u6d4b\u8bd5\u7248), \u4f1a\u6709\u5f88\u591a Bug, \u4e00\u822c\u53ea\u6709\u6d4b\u8bd5\u4eba\u5458\u4f7f\u7528."),(0,l.kt)("li",{parentName:"ul"},"Beta (\u03b2): \u6d4b\u8bd5\u7248 (\u6216\u8005\u53eb\u516c\u5f00\u6d4b\u8bd5\u7248), \u4f1a\u4e00\u76f4\u52a0\u5165\u65b0\u7684\u529f\u80fd."),(0,l.kt)("li",{parentName:"ul"},"RC (Release Candidate): \u6700\u7ec8\u6d4b\u8bd5\u7248\u672c, \u53ef\u80fd\u6210\u4e3a\u6700\u7ec8\u4ea7\u54c1\u7684\u5019\u9009\u7248\u672c."),(0,l.kt)("li",{parentName:"ul"},"\u591a\u6570\u5f00\u6e90\u8f6f\u4ef6\u4f1a\u63a8\u51fa\u4e24\u4e2a RC \u7248\u672c, \u6700\u540e\u7684 RC2 \u5219\u6210\u4e3a\u6b63\u5f0f\u7248\u672c.")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npm version patch\nnpm publish\n\nnpm version minor\nnpm publish\n\nnpm version major\nnpm publish\n")),(0,l.kt)("h3",{id:"tab-completion"},"Tab Completion"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npm completion >> ~/.bashrc (or ~/.zshrc)\nsource ~/.zshrc\n")),(0,l.kt)("h3",{id:"basic-command"},"Basic Command"),(0,l.kt)("p",null,"best practice: ",(0,l.kt)("inlineCode",{parentName:"p"},"npm ci")," for cache install (speed up installation)"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"// With package-lock.json exists:\nnpm ci\n")),(0,l.kt)("p",null,"remove useless package"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npm prune // uninstall node_modules not in package.json\nnpm outdated\n")),(0,l.kt)("h3",{id:"link-command"},"Link Command"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"cd path/to/my-project\nnpm link path/to/my-utils\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# in local B package, build local B binary (npm install -g B)\nnpm link\n# in local A package, set `B` link in package.json to local B binary\nnpm link B\n")),(0,l.kt)("h3",{id:"security-command"},"Security Command"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npm audit fix\nnpm audit fix --force\n")),(0,l.kt)("h3",{id:"npx-command"},"NPX Command"),(0,l.kt)("p",null,"Run local node_modules:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npm install eslint -D\nnpx eslint .\n")),(0,l.kt)("p",null,"Run global package (not installed):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npx create-react-app react-app\n")),(0,l.kt)("p",null,"Run specific version:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'npx -p package1@next -p package2@next -c "command"\n')),(0,l.kt)("p",null,"Run scripts with different node version:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npx -p node@version -- node index.js\n")),(0,l.kt)("p",null,"Run remote repo/gist code:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npx user/repo#branch\nnpx gistUrl\n")),(0,l.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"NPX Cache")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"NPX cache packages in ",(0,l.kt)("inlineCode",{parentName:"p"},"~/.npm/_npx"),"."))),(0,l.kt)("p",null,"To get latest version package:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# https://github.com/return-0x0/node-clear-npx-cache.\n# https://github.com/npm/cli/issues/2329.\n# https://github.com/npm/cli/issues/2395.\n# https://github.com/npm/cli/pull/2592.\n# https://github.com/facebook/create-react-app/issues/10601.\n# https://github.com/facebook/create-react-app/issues/12022.\nnpx clear-npx-cache\nnpx create-react-app app\n")),(0,l.kt)("h3",{id:"npm-dependencies"},"NPM Dependencies"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Dependency Nesting/Hell (NPM v1)."),(0,l.kt)("li",{parentName:"ul"},"Dependency Flatten/Hoist (NPM v3)."),(0,l.kt)("li",{parentName:"ul"},"Dependency Consistent Lockfile (NPM v5 and Yarn)."),(0,l.kt)("li",{parentName:"ul"},"Dependency Hard/Symbol Links (PNPM):",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"Hard links for global ",(0,l.kt)("inlineCode",{parentName:"li"},".pnpm")," store to save disk storage."),(0,l.kt)("li",{parentName:"ul"},"Symbol links for local require short path to\nrectify ",(0,l.kt)("strong",{parentName:"li"},"doppelgangers")," and ",(0,l.kt)("strong",{parentName:"li"},"ghost/phantom dependencies")," problem."))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"peerDependencies"),":\n\u63d0\u793a\u5bbf\u4e3b\u73af\u5883\u53bb\u5b89\u88c5\u6ee1\u8db3\u63d2\u4ef6 ",(0,l.kt)("inlineCode",{parentName:"li"},"peerDependencies")," \u6240\u6307\u5b9a\u4f9d\u8d56\u7684\u5305,\n\u7136\u540e\u5728\u63d2\u4ef6 ",(0,l.kt)("inlineCode",{parentName:"li"},"import")," \u6216\u8005 ",(0,l.kt)("inlineCode",{parentName:"li"},"require")," \u6240\u4f9d\u8d56\u7684\u5305\u7684\u65f6\u5019,\n\u6c38\u8fdc\u90fd\u662f\u5f15\u7528\u5bbf\u4e3b\u73af\u5883\u7edf\u4e00\u5b89\u88c5\u7684 NPM \u5305,\n\u6700\u7ec8\u89e3\u51b3\u63d2\u4ef6\u4e0e\u6240\u4f9d\u8d56\u5305\u4e0d\u4e00\u81f4\u7684\u95ee\u9898."),(0,l.kt)("li",{parentName:"ul"},"\u6784\u5efa\u4f9d\u8d56\u6811\u7684\u8fc7\u7a0b\u4e2d, \u7248\u672c\u786e\u8ba4\u9700\u8981\u7ed3\u5408 ",(0,l.kt)("inlineCode",{parentName:"li"},"package.json")," \u548c ",(0,l.kt)("inlineCode",{parentName:"li"},"package-lock.json"),":",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"\u5148\u786e\u8ba4 ",(0,l.kt)("inlineCode",{parentName:"li"},"package-lock.json")," \u5b89\u88c5\u7248\u672c,\n\u7b26\u5408\u89c4\u5219\u5c31\u4ee5\u6b64\u4e3a\u51c6,\n\u5426\u5219\u7531 ",(0,l.kt)("inlineCode",{parentName:"li"},"package.json")," \u58f0\u660e\u7684\u7248\u672c\u8303\u56f4\u91cd\u65b0\u786e\u8ba4."),(0,l.kt)("li",{parentName:"ul"},"\u82e5\u662f\u5728\u5f00\u53d1\u4e2d\u624b\u52a8\u66f4\u6539\u5305\u4fe1\u606f,\n\u4f1a\u5bfc\u81f4 ",(0,l.kt)("strong",{parentName:"li"},"lockfile")," \u7248\u672c\u4fe1\u606f\u5f02\u5e38,\n\u4e5f\u7531 ",(0,l.kt)("inlineCode",{parentName:"li"},"package.json")," \u91cd\u65b0\u786e\u8ba4."),(0,l.kt)("li",{parentName:"ul"},"\u786e\u8ba4\u597d\u7684\u4f9d\u8d56\u6811\u4f1a\u5b58\u5230 ",(0,l.kt)("inlineCode",{parentName:"li"},"package-lock.json")," \u6587\u4ef6\u4e2d."))),(0,l.kt)("li",{parentName:"ul"},"\u540c\u4e00\u4e2a\u4f9d\u8d56, \u66f4\u9ad8\u7248\u672c\u7684\u5305\u4f1a\u5b89\u88c5\u5230\u9876\u5c42 ",(0,l.kt)("inlineCode",{parentName:"li"},"node_modules")," \u76ee\u5f55,\n\u4f4e\u7248\u672c\u7684\u5305\u4f1a\u5206\u6563\u5728\u67d0\u4e9b\u4f9d\u8d56\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"node_modules")," \u76ee\u5f55."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"Lockfile")," \u4fdd\u8bc1\u9879\u76ee\u4f9d\u8d56\u7ed3\u6784\u7684\u786e\u5b9a\u6027, \u4fdd\u969c\u9879\u76ee\u5728\u591a\u73af\u5883\u8fd0\u884c\u7684\u7a33\u5b9a\u6027.")),(0,l.kt)("h4",{id:"npm-doppelgangers"},"NPM Doppelgangers"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Singleton conflict: multiple version of same package in ",(0,l.kt)("inlineCode",{parentName:"li"},"node_modules"),"."),(0,l.kt)("li",{parentName:"ul"},"Types conflict: global ",(0,l.kt)("inlineCode",{parentName:"li"},"types")," naming conflict.")),(0,l.kt)("h4",{id:"npm-ghost-dependency"},"NPM Ghost Dependency"),(0,l.kt)("p",null,"NPM ghost (phantom) dependency:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Imported packages from ",(0,l.kt)("inlineCode",{parentName:"li"},"dependencies of dependencies"),":\nWhen update ",(0,l.kt)("inlineCode",{parentName:"li"},"dependencies")," to minor version,\n",(0,l.kt)("inlineCode",{parentName:"li"},"dependencies of dependencies")," may get major BREAKING version\n(It's legal for ",(0,l.kt)("inlineCode",{parentName:"li"},"semver"),", when ",(0,l.kt)("inlineCode",{parentName:"li"},"dependencies")," API don't change)."),(0,l.kt)("li",{parentName:"ul"},"Imported packages from ",(0,l.kt)("inlineCode",{parentName:"li"},"devDependencies"),":\nWhen others install your library,\nsuch imported packages will missing,\ncause they aren't located in library ",(0,l.kt)("inlineCode",{parentName:"li"},"package.json"),"."),(0,l.kt)("li",{parentName:"ul"},"Imported packages from root ",(0,l.kt)("inlineCode",{parentName:"li"},"node_modules")," in monorepo.\nWhen others install your library,\nsuch imported packages will missing,\ncause they aren't located in library ",(0,l.kt)("inlineCode",{parentName:"li"},"package.json"),".")),(0,l.kt)("h4",{id:"npm-invalid-dependency"},"NPM Invalid Dependency"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"$ npm ls\npackage@version invalid\n")),(0,l.kt)("p",null,"Modify ",(0,l.kt)("inlineCode",{parentName:"p"},"package-lock.json"),"\nto remove locked invalid package version."),(0,l.kt)("h3",{id:"package-json"},"Package JSON"),(0,l.kt)("h4",{id:"bin"},"Bin"),(0,l.kt)("p",null,"\u5f53\u8bbe\u7f6e\u4e86 ",(0,l.kt)("inlineCode",{parentName:"p"},"bin")," \u5b57\u6bb5\u540e,\n\u5728 ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json")," ",(0,l.kt)("inlineCode",{parentName:"p"},"script")," \u5b57\u6bb5\u4e2d,\n\u53ef\u4ee5\u4f7f\u7528\u7b80\u5199\u7f16\u5199\u547d\u4ee4\n(\u4f46\u662f\u5c40\u90e8\u5b89\u88c5\u65e0\u6cd5\u5728 shell \u4e0b\u4f7f\u7528, \u9700 ",(0,l.kt)("inlineCode",{parentName:"p"},"npx <bin-name>"),")."),(0,l.kt)("h4",{id:"version"},"Version"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npm version major\nnpm version minor\nnpm version patch\n")),(0,l.kt)("h4",{id:"npm-workspaces"},"NPM Workspaces"),(0,l.kt)("p",null,"In root ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "workspaces": [\n    "./packages/*",\n    "./css/*",\n    "./angular/*",\n    "./react/*",\n    "./vue/*"\n  ]\n}\n')),(0,l.kt)("p",null,"In root ",(0,l.kt)("inlineCode",{parentName:"p"},"cwd"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"npm i\nnpm run lint -ws\nnpm run test -w package-a\nnpm i lodash -w package-b\nnpm i -D eslint -w package-c\n")),(0,l.kt)("h4",{id:"exports-field"},"Exports Field"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"exports")," configures the JavaScript level:"),(0,l.kt)("p",null,"File ",(0,l.kt)("inlineCode",{parentName:"p"},"packages/rest/build/gen/util/regexp-tools.js"),"\ncan be imported via ",(0,l.kt)("inlineCode",{parentName:"p"},"@github/rest/gen/util/regexp-tools"),"."),(0,l.kt)("p",null,"It bring two pros:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Don\u2019t need to mention directory ",(0,l.kt)("inlineCode",{parentName:"li"},"build"),"/",(0,l.kt)("inlineCode",{parentName:"li"},"dist")," in module specifiers."),(0,l.kt)("li",{parentName:"ul"},"Don\u2019t need to mention ",(0,l.kt)("inlineCode",{parentName:"li"},".js"),"/",(0,l.kt)("inlineCode",{parentName:"li"},".ts")," in module specifiers.")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("inlineCode",{parentName:"p"},"typesVersions")," for TypeScript finds type definitions (",(0,l.kt)("inlineCode",{parentName:"p"},".d.ts")," files).")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "name": "@github/rest",\n  "private": true,\n  "exports": {\n    "./gen/*": "./build/gen/*.js",\n    "./client/*": "./build/client/*.js",\n    "./contract": "./build/contract.js",\n    "./state": "./build/state.js",\n    "./package.json": "./package.json"\n  },\n  "typesVersions": {\n    "*": {\n      "gen/*": ["build/gen/*"],\n      "client/*": ["build/client/*"],\n      "contract": ["build/contract.d.ts"],\n      "state": ["build/state.d.ts"]\n    }\n  }\n}\n')),(0,l.kt)("h3",{id:"package-lockfile"},"Package Lockfile"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://docs.renovatebot.com/dependency-pinning"},"Dependency pinning"),":"),(0,l.kt)("p",null,"When kept in sync with its associated ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json"),",\na lockfile will further lock down the exact dependencies and sub-dependencies,\nso that everyone running ",(0,l.kt)("inlineCode",{parentName:"p"},"npm i")," or ",(0,l.kt)("inlineCode",{parentName:"p"},"yarn")," will install the exact same dependencies."),(0,l.kt)("p",null,"If the ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json")," contains a range,\nand a new in-range version is released that would break the build,\nthen essentially ",(0,l.kt)("inlineCode",{parentName:"p"},"package.json")," is in a state of ",(0,l.kt)("strong",{parentName:"p"},"broken"),",\neven if the lockfile is still holding things together."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Apps (web or Node.js) that aren't ",(0,l.kt)("inlineCode",{parentName:"li"},"require()")," by other packages\nshould pin all types of dependencies for greatest reliability/predictability."),(0,l.kt)("li",{parentName:"ul"},"Libraries that are ",(0,l.kt)("inlineCode",{parentName:"li"},"consumed"),"/",(0,l.kt)("inlineCode",{parentName:"li"},"required()")," by others\nshould keep using SemVer ranges for ",(0,l.kt)("strong",{parentName:"li"},"dependencies")," (purge multiple version ",(0,l.kt)("inlineCode",{parentName:"li"},"node_modules"),")\nbut can use pinned devDependencies.")),(0,l.kt)("h3",{id:"cli-environment"},"CLI Environment"),(0,l.kt)("p",null,"\u914d\u7f6e\u6587\u4ef6\u4ee5 ",(0,l.kt)("inlineCode",{parentName:"p"},".env"),"/",(0,l.kt)("inlineCode",{parentName:"p"},"JS(Object)"),"/",(0,l.kt)("inlineCode",{parentName:"p"},"JSON"),"/",(0,l.kt)("inlineCode",{parentName:"p"},"JSONP"),"/",(0,l.kt)("inlineCode",{parentName:"p"},"XML"),"/",(0,l.kt)("inlineCode",{parentName:"p"},"YML")," \u683c\u5f0f\u5355\u72ec\u5b58\u653e,\n\u65b9\u4fbf\u8bfb\u53d6."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# .env file (added to .gitignore)\nNODE_ENV=development\nPORT=8626\n# Set your database/API connection information here\nAPI_KEY=**************************\nAPI_URL=**************************\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"// config.js\nconst dotenv = require('dotenv');\ndotenv.config();\n\nmodule.exports = {\n  endpoint: process.env.API_URL,\n  masterKey: process.env.API_KEY,\n  port: process.env.PORT,\n};\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"// server.js\nconst { port } = require('./config');\nconsole.log(`Your port is ${port}`); // 8626\n")),(0,l.kt)("h3",{id:"corepack"},"Corepack"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://github.com/nodejs/corepack"},"Corepack")," is a tool to help with\nmanaging versions of your package managers (package manager manager)."),(0,l.kt)("p",null,"It exposes binary proxies for each supported package manager.\nIt will identify whatever package manager is configured for current project,\ntransparently install it if needed,\nand finally run it without requiring explicit user interactions."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# In npm project\ncorepack yarn\n\n# In npm project\ncorepack pnpm\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"corepack enable yarn\ncorepack disable pnpm\n")),(0,l.kt)("h2",{id:"yarn"},"Yarn"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://yarnpkg.com/getting-started/migration"},"Yarn Berry"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# Modify `/etc/hosts`\nnpm i -g yarn\ncd project/\nyarn set version berry\n")),(0,l.kt)("p",null,"Setup basic configuration ",(0,l.kt)("inlineCode",{parentName:"p"},".yarnrc.yml"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yml"},"yarnPath: .yarn/releases/yarn-berry.cjs\nnodeLinker: node-modules\nnpmPublishAccess: public\nnpmPublishRegistry: 'https://registry.npmjs.org'\nnpmRegistryServer: 'https://registry.npmjs.org'\n")),(0,l.kt)("p",null,"Update ",(0,l.kt)("inlineCode",{parentName:"p"},".gitignore")," file:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},".yarn/*\n!.yarn/patches\n!.yarn/releases\n!.yarn/plugins\n!.yarn/sdks\n!.yarn/versions\n.pnp/\n.pnp.js\n")),(0,l.kt)("h3",{id:"yarn-configuration"},"Yarn Configuration"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'yarn config set nodeLinker node-modules --home\nyarn config set npmPublishAccess public --home\nyarn config set npmRegistryServer "https://registry.npmjs.org" --home\nyarn config set yarnPath .yarn/releases/yarn-berry.cjs --home\nyarn config set unsafeHttpWhitelist --json \'["localhost", "*.example.com", "example.com"]\'\n')),(0,l.kt)("h3",{id:"yarn-updates"},"Yarn Updates"),(0,l.kt)("p",null,"One line to update all deps in monorepo:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"yarn up @types/node\nyarn up @types/react\nyarn dedupe --strategy highest\n")),(0,l.kt)("h3",{id:"yarn-workspace"},"Yarn Workspace"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"yarn workspace packageName build\n")),(0,l.kt)("h3",{id:"yarn-plugin"},"Yarn Plugin"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"yarn plugin list\n")),(0,l.kt)("h3",{id:"yarn-patch"},"Yarn Patch"),(0,l.kt)("p",null,"Modify package in ",(0,l.kt)("inlineCode",{parentName:"p"},"node_modules")," conveniently:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Run ",(0,l.kt)("inlineCode",{parentName:"li"},"yarn patch <package>")," will create copy of ",(0,l.kt)("inlineCode",{parentName:"li"},"package")," to ",(0,l.kt)("inlineCode",{parentName:"li"},"tmp/xfs-xxxxxxxx/user/"),"."),(0,l.kt)("li",{parentName:"ul"},"After modify source code of ",(0,l.kt)("inlineCode",{parentName:"li"},"package"),",\nrun ",(0,l.kt)("inlineCode",{parentName:"li"},"yarn patch-commit /tmp/xfs-xxxxxxxx/user --save"),".")),(0,l.kt)("h3",{id:"yarn-berry-read-world-case"},"Yarn Berry Read World Case"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/gatsbyjs/gatsby"},"Gatsby"),":\nyarn 1 with ",(0,l.kt)("inlineCode",{parentName:"li"},".yarn/")," directory."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/reduxjs/redux-toolkit"},"Redux ToolKit"),":\nyarn 2."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/babel/babel"},"Babel"),":\nyarn 3."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/storybookjs/storybook"},"StoryBook"),":\nyarn 3.")),(0,l.kt)("h2",{id:"self-defined-module"},"Self-Defined Module"),(0,l.kt)("h3",{id:"basic-modular-pattern"},"Basic Modular Pattern"),(0,l.kt)("p",null,"\u7f16\u5199\u5177\u6709\u56de\u8c03\u51fd\u6570\u53c2\u6570\u7684\u6a21\u5757"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5b9a\u4e49\u6a21\u5757")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"function foo(x, y, callback) {\n  try {\n    if (paramNotValid()) {\n      throw new Error('Invalid parameters!');\n    } else {\n      callback(null, param);\n    }\n  } catch (error) {\n    callback(error, param);\n  }\n}\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u4f7f\u7528\u6a21\u5757")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"foo(a, b, function (err, param) {\n  if (err) {\n    processError();\n  } else {\n    process();\n  }\n});\n")),(0,l.kt)("h3",{id:"export-module"},"Export Module"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"module.exports = function (args) {\n  /* ... */\n};\n")),(0,l.kt)("h3",{id:"callback-function"},"CallBack Function"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u5411\u5b9a\u4e49\u6700\u5185\u5c42\u56de\u8c03,\u53ef\u907f\u514d\u56de\u5957\u5d4c\u5957")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"server.on('request', function (req, res) {\n  const render = function (wsData) {\n    page = pageRender(req, session, userData, wsData);\n  };\n  const getWsInfo = function (userData) {\n    ws.get(req, render);\n  };\n  const getDbInfo = function (session) {\n    db.get(session.user, getWsInfo);\n  };\n  const getMemCached = function (req, res) {\n    memcached.getSession(req, getDbInfo);\n  };\n});\n")),(0,l.kt)("h3",{id:"module-resolution"},"Module Resolution"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"const x = require('./module')"),":"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"/root/src/module.js")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"/root/src/module/package.json")," + ",(0,l.kt)("inlineCode",{parentName:"li"},'{ "main": "lib/mainModule.js" }'),"\n= ",(0,l.kt)("inlineCode",{parentName:"li"},"/root/src/module/lib/mainModule.js")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"/root/src/module/index.js"))),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"const x = require('module')"),":"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"/root/src/node_modules/module.js")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"/root/src/node_modules/module/package.json")," (if it specifies a ",(0,l.kt)("inlineCode",{parentName:"li"},"main")," property)"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"/root/src/node_modules/module/index.js")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"/root/node_modules/module.js")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"/root/node_modules/module/package.json")," (if it specifies a ",(0,l.kt)("inlineCode",{parentName:"li"},"main")," property)"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"/root/node_modules/module/index.js")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"/node_modules/module.js")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"/node_modules/module/package.json")," (if it specifies a ",(0,l.kt)("inlineCode",{parentName:"li"},"main")," property)"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"/node_modules/module/index.js"))),(0,l.kt)("h2",{id:"node-module"},"Node Module"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"CommonJS \u6a21\u5757\u5728\u6267\u884c\u9636\u6bb5\u540c\u6b65\u52a0\u8f7d\u5b50\u6a21\u5757\u6587\u4ef6,\nES6 \u6a21\u5757\u5728\u9884\u5904\u7406\u9636\u6bb5\u52a0\u8f7d\u5b50\u6a21\u5757\u6587\u4ef6, ES6 \u6a21\u5757\u5728\u6267\u884c\u9636\u6bb5\u4e5f\u4f1a\u52a0\u8f7d\u5b50\u6a21\u5757\u6587\u4ef6, \u4e0d\u8fc7\u4f1a\u4f7f\u7528\u9884\u5904\u7406\u9636\u6bb5\u7684\u7f13\u5b58."),(0,l.kt)("li",{parentName:"ul"},"CommonJS \u6a21\u5757\u540c\u6b65\u52a0\u8f7d\u5e76\u6267\u884c\u6a21\u5757\u6587\u4ef6, ES6 \u6a21\u5757\u63d0\u524d\u52a0\u8f7d\u5e76\u6267\u884c\u6a21\u5757\u6587\u4ef6.\n\u5f02\u6b65\u901a\u5e38\u88ab\u7406\u89e3\u4e3a\u5ef6\u540e\u4e00\u4e2a\u65f6\u95f4\u8282\u70b9\u6267\u884c, \u6240\u4ee5\u8bf4\u6210\u5f02\u6b65\u52a0\u8f7d\u662f\u9519\u8bef\u7684."),(0,l.kt)("li",{parentName:"ul"},"\u4ece\u5f62\u5f0f\u4e0a\u770b,\nCommonJS \u6a21\u5757\u6574\u4f53\u5bfc\u51fa\u4e00\u4e2a\u5305\u542b\u82e5\u5e72\u4e2a\u53d8\u91cf\u7684\u5bf9\u8c61,\nES6 \u6a21\u5757\u5206\u5f00\u5bfc\u51fa\u5355\u4e2a\u53d8\u91cf.")),(0,l.kt)("h3",{id:"commonjs-module"},"CommonJS Module"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"CommonJS")," \u6a21\u5757\u4e00\u822c\u7531\u5305\u7ba1\u7406\u5668\u63d0\u4f9b\u7684\u8fd0\u884c\u65f6\u5b9e\u73b0."),(0,l.kt)("li",{parentName:"ul"},"\u7531\u4e8e ",(0,l.kt)("inlineCode",{parentName:"li"},"require")," \u8bed\u53e5\u76f4\u63a5\u5206\u5272\u4e86\u6267\u884c\u7684\u4ee3\u7801\u5757,\n",(0,l.kt)("inlineCode",{parentName:"li"},"CommonJS")," \u6a21\u5757\u7684\u5bfc\u5165\u5bfc\u51fa\u8bed\u53e5\u7684\u4f4d\u7f6e\u4f1a\u5f71\u54cd\u6a21\u5757\u4ee3\u7801\u8bed\u53e5\u7684\u6267\u884c\u7ed3\u679c.")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const path = require('path');\nconst fs = require('fs');\nconst vm = require('vm');\n\nfunction Module(id) {\n  this.id = id;\n  this.exports = {};\n}\n\nModule.wrapper = [\n  '(function(exports, module, Require, __dirname, __filename) {',\n  '})',\n];\n\nModule._extensions = {\n  '.js': function (module) {\n    const content = fs.readFileSync(module.id, 'utf8');\n    const fnStr = Module.wrapper[0] + content + Module.wrapper[1];\n    const fn = vm.runInThisContext(fnStr);\n    fn.call(\n      module.exports, // Bind `this` to `module.exports`\n      module.exports,\n      module,\n      Require,\n      _dirname,\n      _filename\n    );\n  },\n  '.json': function (module) {\n    const json = fs.readFileSync(module.id, 'utf8');\n    module.exports = JSON.parse(json); // \u628a\u6587\u4ef6\u7684\u7ed3\u679c\u653e\u5728exports\u5c5e\u6027\u4e0a\n  },\n};\n\nfunction Require(modulePath) {\n  const absPathname = path.resolve(__dirname, modulePath);\n  const module = new Module(absPathname);\n  tryModuleLoad(module);\n  return module.exports;\n}\n\nfunction tryModuleLoad(module) {\n  const extension = path.extname(module.id);\n  Module._extensions[extension](module);\n}\n")),(0,l.kt)("h3",{id:"ecmascript-module"},"EcmaScript Module"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"ES6")," \u6a21\u5757\u501f\u52a9 ",(0,l.kt)("inlineCode",{parentName:"li"},"JS")," \u5f15\u64ce\u5b9e\u73b0.\n",(0,l.kt)("inlineCode",{parentName:"li"},"JS")," \u5f15\u64ce\u5b9e\u73b0\u4e86 ",(0,l.kt)("inlineCode",{parentName:"li"},"ES6")," \u6a21\u5757\u7684\u5e95\u5c42\u6838\u5fc3\u903b\u8f91."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"ES6")," \u6a21\u5757\u6709 5 \u79cd\u72b6\u6001,\n\u5206\u522b\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"unlinked"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"linking"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"linked"),", ",(0,l.kt)("inlineCode",{parentName:"li"},"evaluating")," and ",(0,l.kt)("inlineCode",{parentName:"li"},"evaluated"),"\n(Module Environment Records)."),(0,l.kt)("li",{parentName:"ul"},"\u7531\u4e8e\u8fde\u63a5\u9636\u6bb5\u4f1a\u7ed9\u5bfc\u5165\u6a21\u5757\u53d8\u91cf\u521b\u5efa\u7ed1\u5b9a\u5e76\u521d\u59cb\u5316\u4e3a\u5b50\u6a21\u5757\u7684\u5bf9\u5e94\u53d8\u91cf,\n\u5b50\u6a21\u5757\u7684\u5bf9\u5e94\u53d8\u91cf\u5728\u8bc4\u4f30\u9636\u6bb5\u4f1a\u5148\u88ab\u8d4b\u503c,\n\u6240\u4ee5\u5bfc\u5165\u6a21\u5757\u53d8\u91cf\u83b7\u5f97\u4e86\u548c\u51fd\u6570\u58f0\u660e\u53d8\u91cf\u4e00\u6837\u7684\u63d0\u5347\u6548\u679c.\n",(0,l.kt)("inlineCode",{parentName:"li"},"ES6")," \u6a21\u5757\u7684 ",(0,l.kt)("inlineCode",{parentName:"li"},"import/export")," \u4f4d\u7f6e\u4e0d\u5f71\u54cd\u6a21\u5757\u4ee3\u7801\u8bed\u53e5\u7684\u6267\u884c\u7ed3\u679c."),(0,l.kt)("li",{parentName:"ul"},"Experimental ",(0,l.kt)("inlineCode",{parentName:"li"},".mjs")," file.")),(0,l.kt)("h2",{id:"process-module"},"Process Module"),(0,l.kt)("h3",{id:"process-properties"},"Process Properties"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"process.pid"),": \u5f53\u524d\u8fdb\u7a0b\u7684\u8fdb\u7a0b\u53f7."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"process.version"),": Node \u7684\u7248\u672c, \u6bd4\u5982 v0.10.18."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"process.platform"),": \u5f53\u524d\u7cfb\u7edf\u5e73\u53f0, \u6bd4\u5982 Linux."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"process.title"),": \u9ed8\u8ba4\u503c\u4e3a\u201cnode\u201d, \u53ef\u4ee5\u81ea\u5b9a\u4e49\u8be5\u503c."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"process.argv"),": \u5f53\u524d\u8fdb\u7a0b\u7684\u547d\u4ee4\u884c\u53c2\u6570\u6570\u7ec4."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"process.env"),": \u6307\u5411\u5f53\u524d shell \u7684\u73af\u5883\u53d8\u91cf, \u6bd4\u5982 process.env.HOME."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"process.execPath"),": \u8fd0\u884c\u5f53\u524d\u8fdb\u7a0b\u7684\u53ef\u6267\u884c\u6587\u4ef6\u7684\u7edd\u5bf9\u8def\u5f84."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"process.stdout"),": \u6307\u5411\u6807\u51c6\u8f93\u51fa."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"process.stdin"),": \u6307\u5411\u6807\u51c6\u8f93\u5165."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"process.stderr"),": \u6307\u5411\u6807\u51c6\u9519\u8bef.")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"process.stdin.resume();\nprocess.stdin.pipe(process.stdout);\n")),(0,l.kt)("h3",{id:"process-events"},"Process Events"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Error events:",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"uncaughtException"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"unhandledRejection"),"."))),(0,l.kt)("li",{parentName:"ul"},"Signal events:",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"SIGHUP"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"SIGINT"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"SIGQUIT"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"SIGTERM"),"."))),(0,l.kt)("li",{parentName:"ul"},"Exit events:",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"beforeExit"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"exit"),"."))),(0,l.kt)("li",{parentName:"ul"},"Node HTTP applications graceful shutdown\n",(0,l.kt)("a",{parentName:"li",href:"https://github.com/godaddy/terminus"},"library"),".")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"process.on('uncaughtException', err => {\n  console.log(`Uncaught exception: ${err.message}.`);\n  process.exit(1);\n});\nprocess.on('uncaughtException', (reason, promise) => {\n  console.log(`Unhandled rejection at ${promise}, reason: ${reason}.`);\n  process.exit(1);\n});\n\nprocess.on('SIGHUP', signal => {\n  console.log(`Process ${process.pid} received a SIGHUP signal.`);\n  process.exit(0);\n});\nprocess.on('SIGINT', signal => {\n  console.log(`Process ${process.pid} has been interrupted.`);\n  process.exit(0);\n});\nprocess.on('SIGQUIT', signal => {\n  console.log(`Process ${process.pid} received a SIGQUIT signal.`);\n  process.exit(0);\n});\nprocess.on('SIGTERM', signal => {\n  console.log(`Process ${process.pid} received a SIGTERM signal.`);\n  process.exit(0);\n});\n\nprocess.on('beforeExit', code => {\n  setTimeout(() => {\n    console.log(`Process will exit with code: ${code}.`);\n    process.exit(code);\n  });\n});\nprocess.on('exit', code => {\n  console.log(`Process exited with code: ${code}.`);\n});\n")),(0,l.kt)("h3",{id:"process-information"},"Process Information"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"process.on()"),(0,l.kt)("li",{parentName:"ul"},"process.uptime(): \u8fdb\u7a0b\u8fd0\u884c\u65f6\u957f"),(0,l.kt)("li",{parentName:"ul"},"process.getgid/setgid/getuid/setuid();"),(0,l.kt)("li",{parentName:"ul"},"process.cwd()"),(0,l.kt)("li",{parentName:"ul"},"process.memoryUsage()")),(0,l.kt)("h3",{id:"process-event-loop-and-counter"},"Process Event Loop and Counter"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"process.nextTick()")),(0,l.kt)("h3",{id:"child-process"},"Child Process"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"cp.spawn()"),": \u521b\u5efa\u5b50\u8fdb\u7a0b, \u62e5\u6709\u72ec\u7acb\u7684 stdin/stdout/stderr \u6587\u4ef6\u63cf\u8ff0\u7b26"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"cp.exec()"),": \u521b\u5efa\u5b50\u8fdb\u7a0b, \u5e76\u4f1a\u5728\u8fdb\u7a0b\u7ed3\u675f\u65f6\u8c03\u7528\u4f20\u5165\u7684\u56de\u8c03\u51fd\u6570"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/sindresorhus/execa"},"Exec Library")),(0,l.kt)("li",{parentName:"ul"},"Each spawned Node.js child process is independent\nand has its own memory, event-loop, and V8 instance."),(0,l.kt)("li",{parentName:"ul"},"Use ",(0,l.kt)("inlineCode",{parentName:"li"},"process.on")," to communicate between parent and child process.")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const cp = require('child_process');\n\ncp.exec(\n  'ls -l',\n  {\n    encoding: 'uft-8',\n    timeout: 0,\n    maxBuffer: 200 * 1024,\n    killSignal: 'SIGTERM',\n    setsid: false,\n    cwd: null,\n    env: null,\n  },\n  function (err, stdout, stderr) {\n    if (!err) {\n      console.log(stdout);\n      console.log(stderr);\n    }\n  }\n);\n")),(0,l.kt)("h2",{id:"worker-threads-module"},"Worker Threads Module"),(0,l.kt)("p",null,"Worker threads use threads to execute the work\nwithin the same process of the main application:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Worker threads are lightweight compared to child processes."),(0,l.kt)("li",{parentName:"ul"},"Worker threads can share memory (can transfer ",(0,l.kt)("inlineCode",{parentName:"li"},"ArrayBuffer"),")."),(0,l.kt)("li",{parentName:"ul"},"Each Node.js worker thread has its own independent Node.js runtime\n(including its own V8 instance, event loop, etc.)\nwith its own isolated context,\ntherefore ",(0,l.kt)("strong",{parentName:"li"},"no thread synchronization")," is usually needed.")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"// fibonacci-worker.js\nconst {\n  Worker,\n  isMainThread,\n  parentPort,\n  workerData,\n} = require('worker_threads');\n\nfunction fibonacci(num) {\n  if (num <= 1) return num;\n  return fibonacci(num - 1) + fibonacci(num - 2);\n}\n\nif (isMainThread) {\n  module.exports = n =>\n    new Promise((resolve, reject) => {\n      const worker = new Worker(__filename, {\n        workerData: n,\n      });\n      worker.on('message', resolve);\n      worker.on('error', reject);\n      worker.on('exit', code => {\n        if (code !== 0) {\n          reject(new Error(`Worker stopped with exit code ${code}`));\n        }\n      });\n    });\n} else {\n  const result = fibonacci(workerData);\n  parentPort.postMessage(result);\n  process.exit(0);\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const http = require('http');\nconst fibonacciWorker = require('./fibonacci-worker');\n\nconst port = 3000;\n\nhttp\n  .createServer(async (req, res) => {\n    const url = new URL(req.url, `http://${req.headers.host}`);\n    console.log('Incoming request to:', url.pathname);\n\n    if (url.pathname === '/fibonacci') {\n      const n = Number(url.searchParams.get('n'));\n      console.log('Calculating fibonacci for', n);\n\n      const result = await fibonacciWorker(n);\n      res.writeHead(200);\n      return res.end(`Result: ${result}\\n`);\n    } else {\n      res.writeHead(200);\n      return res.end('Hello World!');\n    }\n  })\n  .listen(port, () => console.log(`Listening on port ${port}...`));\n")),(0,l.kt)("p",null,"Worker pool is needed:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Creating a new worker/process is expensive.\nFor best performance, they should be reused."),(0,l.kt)("li",{parentName:"ul"},"No control over the number of workers/processes created without worker pool.\nThis leaves vulnerable to DoS attacks."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/josdejong/workerpool"},"Worker pool library"))),(0,l.kt)("h2",{id:"file-module"},"File Module"),(0,l.kt)("h3",{id:"fs-api"},"FS API"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"fs.createReadStream."),(0,l.kt)("li",{parentName:"ul"},"fs.opendir."),(0,l.kt)("li",{parentName:"ul"},"fs.readdir."),(0,l.kt)("li",{parentName:"ul"},"fs.readFile."),(0,l.kt)("li",{parentName:"ul"},"fs.readFileSync."),(0,l.kt)("li",{parentName:"ul"},"fs.exists.")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const fs = require('fs');\n\nfunction readFile(filename) {\n  return new Promise((resolve, reject) => {\n    fs.readFile(filename, { encoding: 'utf8' }, (err, contents) => {\n      if (err) {\n        reject(err);\n        return;\n      }\n\n      resolve(contents);\n    });\n  });\n}\n\nreadFile('example.txt')\n  .then(contents => {\n    console.log(contents);\n  })\n  .catch(err => {\n    console.error(err.message);\n  });\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"import { promises as fs } from 'fs';\nimport { basename, dirname, join } from 'path';\n\nasync function* walk(dir: string): AsyncGenerator<string> {\n  for await (const d of await fs.opendir(dir)) {\n    const entry = join(dir, d.name);\n\n    if (d.isDirectory()) {\n      yield* walk(entry);\n    } else if (d.isFile()) {\n      yield entry;\n    }\n  }\n}\n\nasync function run(arg = '.') {\n  if ((await fs.lstat(arg)).isFile()) {\n    return runTestFile(arg);\n  }\n\n  for await (const file of walk(arg)) {\n    if (\n      !dirname(file).includes('node_modules') &&\n      (basename(file) === 'test.js' || file.endsWith('.test.js'))\n    ) {\n      console.log(file);\n      await runTestFile(file);\n    }\n  }\n}\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"import fs from 'node:fs/promises';\nimport path from 'node:path';\n\nconst traverse = async directory => {\n  const files = await fs.readdir(directory);\n\n  files.forEach(async file => {\n    const filePath = path.join(directory, file);\n    const fileStat = await fs.stat(filePath);\n\n    if (fileStat.isFile()) {\n      const content = await fs.readFile(filePath, 'utf-8');\n      console.log(content);\n    } else if (fileStat.isDirectory()) {\n      await traverse(filePath);\n    }\n  });\n};\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"module.exports = function ls(dirName, fileType, callback) {\n  const fs = require('fs');\n  const path = require('path');\n\n  fs.readdir(dirName, function (err, list) {\n    if (err) {\n      return callback(err);\n    }\n\n    list = list.filter(function (file) {\n      return path.extname(file) === `.${fileType}`;\n    });\n\n    callback(null, list);\n  });\n};\n")),(0,l.kt)("h3",{id:"buffer-object"},"Buffer Object"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const str = buf.toString();\n")),(0,l.kt)("h3",{id:"path-api"},"Path API"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"path.resolve: \u81ea\u52a8\u6309\u7cfb\u7edf\u5904\u7406\u8def\u5f84"),(0,l.kt)("li",{parentName:"ul"},"path.extname: \u8fd4\u56de\u6587\u4ef6\u7c7b\u578b")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const path = require('path');\n\nconsole.log(path.extname('index.html')); // .html\n\npath.normalize(p);\npath.join([path1], [path2], [pathN]);\npath.resolve(from, to);\npath.relative(from, to);\npath.dirname(p);\npath.basename(p, [ext]);\npath.extname(p);\nconst separator = path.sep;\nconst delimiter = path.delimiter;\n")),(0,l.kt)("h2",{id:"http-module"},"Http Module"),(0,l.kt)("h3",{id:"request-object"},"Request Object"),(0,l.kt)("h4",{id:"\u5c5e\u6027"},"\u5c5e\u6027"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const request = {\n  method: 'POST',\n};\n")),(0,l.kt)("h3",{id:"response-object"},"Response Object"),(0,l.kt)("h4",{id:"\u7c7b\u578b"},"\u7c7b\u578b"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cpp"},"typedef Stream response\n")),(0,l.kt)("h4",{id:"\u4e8b\u4ef6"},"\u4e8b\u4ef6"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u76d1\u542c\u4e8b\u4ef6")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"response.on('data', function (data) {\n  process(data);\n});\nresponse.on('error', function (err) {\n  console.error(err);\n});\nresponse.on('end', function () {\n  stream.end();\n});\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u53d1\u51fa\u4e8b\u4ef6")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"response.end(); //  \u4f20\u8f93\u7ed3\u675f\n")),(0,l.kt)("h4",{id:"\u65b9\u6cd5"},"\u65b9\u6cd5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"response.setEncoding('utf8'); // \u81ea\u52a8\u5c06 data \u4e8b\u4ef6\u4e2d Buffer \u5bf9\u8c61\u8f6c\u6362\u6210 String\n\n//  content-type: text/plain\n//                application/json\nresponse.writeHead(200, { 'Content-Type': '' });\n")),(0,l.kt)("h3",{id:"http-get"},"Http Get"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"http.get(url, function callback(response) {});\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"http.get(url, function (response) {\n  let pipeData = '';\n\n  response.setEncoding('utf8');\n  response.on('data', function (data) {\n    pipeData += data;\n  });\n  response.on('end', function () {\n    console.log(pipeData.length);\n    console.log(pipeData);\n  });\n});\n")),(0,l.kt)("h3",{id:"http-server"},"Http Server"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const server = http.createServer(function (request, response) {\n  // \u5904\u7406\u8bf7\u6c42\u7684\u903b\u8f91...\n});\nserver.listen(8000);\n")),(0,l.kt)("h3",{id:"sample"},"Sample"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const net = require('net');\nconst chatServer = net.createServer();\n// \u7528\u4e8e\u68c0\u6d4b\u50f5\u5c38\u5ba2\u6237\u7aef,\u7528\u4e8e\u53ca\u65f6\u6e05\u695a\u50f5\u5c38\u5ba2\u6237\u7aef\nconst clientList = [];\n\nchatServer.on('connection', function (client) {\n  client.name = `${client.remoteAddress}:${client.remotePort}`;\n  client.write(`Hi ${client.name}!\\n`);\n  clientList.push(client);\n\n  client.on('data', function (data) {\n    broadcast(data, client);\n  });\n  client.on('end', function () {\n    clientList.splice(clientList.indexOf(client), 1);\n  });\n  client.on('error', function (e) {\n    console.log(e);\n  });\n});\n\nfunction broadcast(message, client) {\n  const cleanup = [];\n\n  for (let i = 0; i < clientList.length; i += 1) {\n    // \u5411\u5176\u4ed6\u4eba(\u6392\u9664\u81ea\u8eab)\u53d1\u9001\u6d88\u606f\n    if (client !== clientList[i]) {\n      if (clientList[i].writable) {\n        clientList[i].write(`${client.name} says ${message}`);\n      } else {\n        cleanup.push(clientList[i]);\n        clientList[i].destroy();\n      }\n    }\n  }\n\n  // \u6e05\u695a\u50f5\u5c38\u5ba2\u6237\u7aef\n  for (let i = 0; i < cleanup.length; i += 1) {\n    clientList.splice(clientList.indexOf(cleanup[i]), 1);\n  }\n}\n\nchatServer.listen(9000);\n")),(0,l.kt)("h2",{id:"net-module"},"Net Module"),(0,l.kt)("h3",{id:"socket-object"},"Socket Object"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"socket.write(data);\nsocket.end(data);\nsocket.end();\n")),(0,l.kt)("h3",{id:"socket-io"},"Socket IO"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const http = require('http');\nconst fs = require('fs');\nconst io = require('socket.io');\nconst sockFile = fs.readFileSync('socket.html');\n\nserver = http.createServer();\nserver.on('request', function (req, res) {\n  res.writeHead(200, { 'content-type': 'text/html' });\n  res.end(sockFile);\n});\nserver.listen(8080);\n\nconst socket = io.listen(server);\n\n// \u547d\u540d\u7a7a\u95f4\nsocket.of('/upAndRunning').on('connection', function (client) {\n  console.log('Client connected to Up and Running namespace.');\n  client.send(\"Welcome to 'Up and Running'\");\n});\nsocket.of('/weather').on('connection', function (client) {\n  console.log('Client connected to Weather namespace.');\n  client.send(\"Welcome to 'Weather Updates'\");\n});\n")),(0,l.kt)("h3",{id:"basic-methods"},"Basic Methods"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const serverInstance = net.createServer(function callback(socket) {});\n\nserverInstance.listen(portNumber); // \u5f00\u59cb\u76d1\u542c\u7279\u5b9a\u7aef\u53e3\n")),(0,l.kt)("h2",{id:"url-module"},"URL Module"),(0,l.kt)("h3",{id:"basic-method"},"Basic Method"),(0,l.kt)("h4",{id:"parse"},"parse"),(0,l.kt)("p",null,"\u89e3\u6790\u5904 URL \u5404\u4e2a\u7ec4\u6210\u90e8\u5206:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"href"),(0,l.kt)("li",{parentName:"ul"},"protocol"),(0,l.kt)("li",{parentName:"ul"},"host"),(0,l.kt)("li",{parentName:"ul"},"auth"),(0,l.kt)("li",{parentName:"ul"},"hostname"),(0,l.kt)("li",{parentName:"ul"},"port"),(0,l.kt)("li",{parentName:"ul"},"pathname"),(0,l.kt)("li",{parentName:"ul"},"search"),(0,l.kt)("li",{parentName:"ul"},"query"),(0,l.kt)("li",{parentName:"ul"},"hash")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"// true \u8868\u793a\u8c03\u7528 queryString \u6a21\u5757\u67e5\u8be2\u5b57\u7b26\u4e32\nurl.parse(request.url, true);\n")),(0,l.kt)("h3",{id:"dns"},"dns"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"dns.resolve"),(0,l.kt)("li",{parentName:"ul"},"dns.reverse"),(0,l.kt)("li",{parentName:"ul"},"dns.lookup")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const dns = require('dns');\n\ndns.lookup('google.com', 4, function (e, a) {\n  console.log(a);\n});\n\ndns.resolve('tazimi.tk', 'A', function (e, r) {\n  if (e) {\n    console.log(e);\n  }\n  console.log(JSON.stringify(r, null, 2));\n});\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const dns = require('dns');\n\ndns.resolve('tazimi.dev', 'A', function (err, res) {\n  if (err) {\n    console.log(err);\n  } else {\n    console.log(`A: ${JSON.stringify(res, null, 2)}`);\n  }\n});\n\ndns.resolve('github.com', 'MX', function (err, res) {\n  if (err) {\n    console.log(err);\n  } else {\n    console.log(`MX: ${JSON.stringify(res, null, 2)}`);\n  }\n});\n")),(0,l.kt)("h2",{id:"security-module"},"Security Module"),(0,l.kt)("h3",{id:"crypto"},"Crypto"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"hash algorithm"),(0,l.kt)("li",{parentName:"ul"},"hmac algorithm"),(0,l.kt)("li",{parentName:"ul"},"cipher/decipher algorithms"),(0,l.kt)("li",{parentName:"ul"},"signature/validate")),(0,l.kt)("h4",{id:"hash-api"},"Hash API"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const crypto = require('crypto');\nconst md5 = crypto.createHash('md5');\n\nmd5.update('foo');\nmd5.digest('hex'); // 'acbd18db4cc2f85cedef654fccc4a4d8'\n")),(0,l.kt)("h4",{id:"hmac-api"},"HMAC API"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"openssl genrsa -out key.pem 1024\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const crypto = require('crypto');\nconst fs = require('fs');\nconst pem = fs.readFileSync('key.pem');\nconst key = pem.toString('ascii');\nconst hmac = crypto.createHmac('sha1', key);\n\nhmac.update('bar');\nhmac.digest('hex'); // '7x123'\n")),(0,l.kt)("h4",{id:"\u516c\u94a5\u52a0\u5bc6"},"\u516c\u94a5\u52a0\u5bc6"),(0,l.kt)("h2",{id:"async-modules"},"Async Modules"),(0,l.kt)("p",null,"\u5bf9\u56de\u8c03\u8fdb\u884c\u8ba1\u6570\u662f\u5904\u7406 Node \u4e2d\u5f02\u6b65\u7684\u57fa\u7840 - \u81ea\u5b9a\u4e49 Semaphore \u53d8\u91cf: \u6bcf\u5b8c\u6210\u4e00\u4e2a\u5f02\u6b65\u5904\u7406, Semaphore++"),(0,l.kt)("h3",{id:"cluster-module"},"Cluster Module"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const cluster = require('cluster');\nconst http = require('http');\nconst numCPUs = require('os').cpus().length;\nconst rssWarn = 50 * 1024 * 1024;\nconst heapWarn = 50 * 1024 * 1024;\nconst workers = {};\n\nif (cluster.isMaster) {\n  for (let i = 0; i < numCPUs; i++) {\n    createWorker();\n  }\n  setInterval(function () {\n    const time = new Date().getTime();\n    for (pid in workers) {\n      if (\n        Object.prototype.hasOwnProperty.call(workers, pid) &&\n        workers[pid].lastCb + 5000 < time\n      ) {\n        console.log(`Long running worker ${pid} killed`);\n        workers[pid].worker.kill();\n        delete workers[pid];\n        createWorker();\n      }\n    }\n  }, 1000);\n} else {\n  // Server\n  http\n    .Server(function (req, res) {\n      // mess up 1 in 200 request\n      if (Math.floor(Math.random() * 200) === 4) {\n        console.log(`Stopped ${process.pid} from ever finishing`);\n        while (true) {\n          continue;\n        }\n      }\n      res.writeHead(200);\n      res.end(`hello world from ${process.pid}\\n`);\n    })\n    .listen(8000);\n  // Report stats once a second\n  setInterval(function report() {\n    process.send({\n      cmd: 'reportMem',\n      memory: process.memoryUsage(),\n      process: process.pid,\n    });\n  }, 1000);\n}\n\nfunction createWorker() {\n  const worker = cluster.fork();\n  console.log(`Created worker: ${worker.pid}`);\n\n  // allow boot time\n  workers[worker.pid] = { worker, lastCb: new Date().getTime() - 1000 };\n  worker.on('message', function (m) {\n    if (m.cmd === 'reportMem') {\n      workers[m.process].lastCb = new Date().getTime();\n      if (m.memory.rss > rssWarn) {\n        console.log(`Worker ${m.process} using too much memory.`);\n      }\n    }\n  });\n}\n")),(0,l.kt)("h2",{id:"test-module"},"Test Module"),(0,l.kt)("h3",{id:"assert-module"},"Assert Module"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"assert.equal(expect, real, assertPrompt)"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"assert.notEqual(expect, real, assertPrompt)"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"assert.strictEqual(expect, real, assertPrompt)"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"assert.notStrictEqual(expect, real, assertPrompt)"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"assert.deepEqual(expect, real, assertPrompt)"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"assert.notDeepEqual(expect, real, assertPrompt)"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"assert.ok(var, assertPrompt): \u6d4b\u8bd5\u5bf9\u8c61\u771f\u503c(truthy/falsy)"),"."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"assert.throws(fn)"),": \u6d4b\u8bd5\u65b9\u6cd5\u662f\u5426\u629b\u51fa\u5f02\u5e38."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"assert.doesNotThrow(fn)"),": \u6d4b\u8bd5\u65b9\u6cd5\u662f\u5426\u629b\u51fa\u5f02\u5e38.")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const assert = require('assert');\n\nassert.equal(1, true, 'Truthy');\nassert.notEqual(1, true, 'Truthy');\n\nassert.ok(0, 'Zero is not truthy');\n")),(0,l.kt)("h2",{id:"node-web-crawler"},"Node Web Crawler"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://www.zenrows.com/blog/web-scraping-with-javascript-and-nodejs"},"Simple example"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ts"},"const axios = require('axios');\nconst playwright = require('playwright');\nconst cheerio = require('cheerio');\n\nconst url = 'https://scrapeme.live/shop/page/1/';\nconst useHeadless = false; // \"true\" to use playwright\nconst maxVisits = 30; // Arbitrary number for the maximum of links visited\nconst visited = new Set();\nconst allProducts = [];\n\nconst sleep = ms => new Promise(resolve => setTimeout(resolve, ms));\n\nconst getHtmlPlaywright = async url => {\n  const browser = await playwright.firefox.launch();\n  const context = await browser.newContext();\n  const page = await context.newPage();\n  await page.goto(url);\n  const html = await page.content();\n  await browser.close();\n\n  return html;\n};\n\nconst getHtmlAxios = async url => {\n  const { data } = await axios.get(url);\n\n  return data;\n};\n\nconst getHtml = async url => {\n  return useHeadless ? await getHtmlPlaywright(url) : await getHtmlAxios(url);\n};\n\nconst extractContent = $ =>\n  $('.product')\n    .map((_, product) => {\n      const $product = $(product);\n\n      return {\n        id: $product.find('a[data-product_id]').attr('data-product_id'),\n        title: $product.find('h2').text(),\n        price: $product.find('.price').text(),\n      };\n    })\n    .toArray();\n\nconst extractLinks = $ => [\n  ...new Set(\n    $('.page-numbers a')\n      .map((_, a) => $(a).attr('href'))\n      .toArray()\n  ),\n];\n\nconst crawl = async url => {\n  visited.add(url);\n  console.log('Crawl: ', url);\n  const html = await getHtml(url);\n  const $ = cheerio.load(html);\n  const content = extractContent($);\n  const links = extractLinks($);\n  links\n    .filter(link => !visited.has(link))\n    .forEach(link => {\n      q.enqueue(crawlTask, link);\n    });\n  allProducts.push(...content);\n\n  // We can see how the list grows. Gotta catch 'em all!\n  console.log(allProducts.length);\n};\n\n// Change the default concurrency or pass it as param\nconst queue = (concurrency = 4) => {\n  let running = 0;\n  const tasks = [];\n\n  return {\n    enqueue: async (task, ...params) => {\n      tasks.push({ task, params });\n      if (running >= concurrency) {\n        return;\n      }\n\n      ++running;\n      while (tasks.length) {\n        const { task, params } = tasks.shift();\n        await task(...params);\n      }\n      --running;\n    },\n  };\n};\n\nconst crawlTask = async url => {\n  if (visited.size >= maxVisits) {\n    console.log('Over Max Visits, exiting');\n    return;\n  }\n\n  if (visited.has(url)) {\n    return;\n  }\n\n  await crawl(url);\n};\n\nconst q = queue();\nq.enqueue(crawlTask, url);\n")),(0,l.kt)("h2",{id:"node-reference"},"Node Reference"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://nodejs.dev/learn"},"Node.js Dev")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://alexkondov.com/tao-of-node"},"Tao of Node"))))}d.isMDXComponent=!0}}]);