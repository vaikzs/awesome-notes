<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-computerScience/operatingSystems/operatingSystemsBasicNotes">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.18">
<title data-rh="true">Operating System Basic Notes | Awesome Notes</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://sabertazimi.github.io/awesome-notes/computerScience/operatingSystems/operatingSystemsBasicNotes"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Operating System Basic Notes | Awesome Notes"><meta data-rh="true" name="description" content="OS Definition"><meta data-rh="true" property="og:description" content="OS Definition"><link data-rh="true" rel="icon" href="/awesome-notes/img/logo.svg"><link data-rh="true" rel="canonical" href="https://sabertazimi.github.io/awesome-notes/computerScience/operatingSystems/operatingSystemsBasicNotes"><link data-rh="true" rel="alternate" href="https://sabertazimi.github.io/awesome-notes/computerScience/operatingSystems/operatingSystemsBasicNotes" hreflang="en"><link data-rh="true" rel="alternate" href="https://sabertazimi.github.io/awesome-notes/computerScience/operatingSystems/operatingSystemsBasicNotes" hreflang="x-default"><link rel="stylesheet" href="/awesome-notes/assets/css/styles.899e2864.css">
<link rel="preload" href="/awesome-notes/assets/js/runtime~main.d7ce8a84.js" as="script">
<link rel="preload" href="/awesome-notes/assets/js/main.12b2598d.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_ObN2"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/awesome-notes/"><div class="navbar__logo"><img src="/awesome-notes/img/logo.svg" alt="Awesome Notes" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/awesome-notes/img/logo.svg" alt="Awesome Notes" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Awesome Notes</b></a><a class="navbar__item navbar__link" href="/awesome-notes/intro">Notes</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/awesome-notes/computerScience/algorithms/algorithmsBasicNotes">Computer Science</a><a class="navbar__item navbar__link" href="/awesome-notes/programming/android/androidBasicNotes">Programming</a><a class="navbar__item navbar__link" href="/awesome-notes/language/assembly/assemblyBasicNotes">Language</a><a class="navbar__item navbar__link" href="/awesome-notes/web/angular/angularBasicNotes">Web</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Links</a><ul class="dropdown__menu"><li><a href="https://github.com/sabertazimi" target="_blank" rel="noopener noreferrer" class="dropdown__link">GitHub<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://twitter.com/sabertazimi" target="_blank" rel="noopener noreferrer" class="dropdown__link">Twitter<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="mailto:sabertazimi@gmail.com" target="_blank" rel="noopener noreferrer" class="dropdown__link">Email<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Repos</a><ul class="dropdown__menu"><li><a href="https://github.com/sabertazimi/awesome-web" target="_blank" rel="noopener noreferrer" class="dropdown__link">Awesome Web<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/sabertazimi/bod" target="_blank" rel="noopener noreferrer" class="dropdown__link">Bod CLI<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/sabertazimi/blog" target="_blank" rel="noopener noreferrer" class="dropdown__link">Gatsby Blog<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://notes.tazimi.dev" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitBook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/sabertazimi/awesome-notes" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="docPage_P2Lg"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><aside class="theme-doc-sidebar-container docSidebarContainer_rKC_"><div class="sidebar_RiAD sidebarWithHideableNavbar_d0QC"><a tabindex="-1" class="sidebarLogo_YUvz" href="/awesome-notes/"><img src="/awesome-notes/img/logo.svg" alt="Awesome Notes" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/awesome-notes/img/logo.svg" alt="Awesome Notes" class="themedImage_W2Cr themedImage--dark_oUvU"><b>Awesome Notes</b></a><nav class="menu thin-scrollbar menu_izAj"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/awesome-notes/intro">Awesome Notes</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/awesome-notes/computerScience/algorithms/algorithmsBasicNotes">Computer Science</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/awesome-notes/computerScience/algorithms/algorithmsBasicNotes">algorithms</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/awesome-notes/computerScience/architecture/archBasicNotes">architecture</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/awesome-notes/computerScience/compilers/compilersBasicNotes">compilers</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/awesome-notes/computerScience/database/databaseBasicNotes">database</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/awesome-notes/computerScience/latex/latexBasicNotes">latex</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/awesome-notes/computerScience/math/mathBasicNotes">math</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/awesome-notes/computerScience/network/networkBasicNotes">network</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/awesome-notes/computerScience/operatingSystems/CSAPP">operatingSystems</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/awesome-notes/computerScience/operatingSystems/CSAPP">Computer Systems: A Programmer&#x27;s Perspective Basic Notes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/awesome-notes/computerScience/operatingSystems/operatingSystemsBasicNotes">Operating System Basic Notes</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/awesome-notes/computerScience/virtualization/virtualBasicNotes">virtualization</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/awesome-notes/programming/android/androidBasicNotes">Programming</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/awesome-notes/language/assembly/assemblyBasicNotes">Language</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/awesome-notes/web/angular/angularBasicNotes">Web</a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_FykI"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_DTRl"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_TCnq"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/awesome-notes/">🏠</a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><span class="breadcrumbs__link" itemprop="item name">Computer Science</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><span class="breadcrumbs__link" itemprop="item name">operatingSystems</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="item name">Operating System Basic Notes</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_jdIR theme-doc-toc-mobile tocMobile_TmEX"><button type="button" class="clean-btn tocCollapsibleButton_Fzxq">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Operating System Basic Notes</h1><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="os-definition">OS Definition<a class="hash-link" href="#os-definition" title="Direct link to heading">​</a></h2><p>操作系统是一个大型的程序系统, 它负责(处理机管理, 存储管理, 设备管理, 文件系统):</p><ul><li>计算机系统软、硬件资源的分配和使用</li><li>控制和协调并发活动</li><li>提供用户接口, 使用户获得良好的工作环境</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="gcc-内联汇编">GCC 内联汇编<a class="hash-link" href="#gcc-内联汇编" title="Direct link to heading">​</a></h2><div class="codeBlockContainer_I0IT language-cpp theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-cpp codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">asm</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> assembler </span><span class="token keyword" style="color:#00009f">template</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// assembly language</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">output operands </span><span class="token comment" style="color:#999988;font-style:italic">// 约定输出</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">input operands </span><span class="token comment" style="color:#999988;font-style:italic">// 约定输入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">:</span><span class="token plain">clobbers </span><span class="token comment" style="color:#999988;font-style:italic">// 约定插入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><p>constraints:</p><ul><li>m/v/o = memory</li><li>r = register</li><li>Q = ea/b/c/dx</li><li>a = eax</li><li>b = ebx</li><li>c = ecx</li><li>d = edx</li><li>D = edi</li><li>S = esi</li><li>0/n = first/nth constraints</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="基本概念">基本概念<a class="hash-link" href="#基本概念" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="操作系统的特性">操作系统的特性<a class="hash-link" href="#操作系统的特性" title="Direct link to heading">​</a></h3><ul><li>并发性 : 能处理多个同时性活动的能力</li><li>共享性 : 多个计算任务对系统资源的共同享用</li><li>不确定性: 操作系统能处理随机发生的多个事件 - 程序运行次序的不确定性, 程序运行时间的不确定性</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="操作系统的资源管理功能">操作系统的资源管理功能<a class="hash-link" href="#操作系统的资源管理功能" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="处理器调度">处理器调度<a class="hash-link" href="#处理器调度" title="Direct link to heading">​</a></h4><ul><li>确定进程调度策略</li><li>给出进程调度算法</li><li>进行处理机的分派</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="存储器管理">存储器管理<a class="hash-link" href="#存储器管理" title="Direct link to heading">​</a></h4><ul><li>存储分配与存储无关性</li></ul><p>为用户提供逻辑地址, 解决主存分配问题</p><ul><li>存储保护</li></ul><p>实现系统程序与用户程序之间的隔离, 实现不同用户程序之间的隔离</p><ul><li>存储扩充</li></ul><p>虚拟内存管理: 主存+磁盘, 为每个进程管理一个虚拟内存映射链表</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="设备管理">设备管理<a class="hash-link" href="#设备管理" title="Direct link to heading">​</a></h4><ul><li>设备无关性</li></ul><p>用户向系统申请和使用的设备无关实际操作的设备, 操作系统为用户提供统一的逻辑设备(名)</p><ul><li>设备分配(独享分配/共享分配/虚拟分配)</li><li>设备的传输控制(设备启动处理, 设备中断处理, 设备结束处理)</li></ul><p>组织设备完成 I/O 操作, 并正确处理中断</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="文件资源管理">文件资源管理<a class="hash-link" href="#文件资源管理" title="Direct link to heading">​</a></h4><p>为用户提供一种简便、统一的存取和管理信息的方法, 解决信息的共享/数据的存取控制/数据的保密等问题:</p><ul><li>实现用户的信息组织</li><li>提供存取方法</li><li>实现文件共享</li><li>保证文件安全</li><li>保证文件完整性</li><li>完成磁盘空间分配</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="操作系统的演变">操作系统的演变<a class="hash-link" href="#操作系统的演变" title="Direct link to heading">​</a></h3><ul><li>单用户系统(45-55) -&gt; 批处理系统(55-65) -&gt; 多道系统(65-80) -&gt; 分时系统(70-) -&gt; 分布式系统</li><li>手工系统 -人机矛盾-&gt; 联机批处理系统 -CPU I/O 矛盾
-&gt; 脱机批处理系统 -响应能力-&gt; 执行系统(中断/通道) -并行-&gt;
多道批处理系统(粗粒度) -&gt; 分时系统(细粒度) -&gt; 实时系统 -&gt; 个人/网络/分布式系统</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="批处理系统">批处理系统<a class="hash-link" href="#批处理系统" title="Direct link to heading">​</a></h4><p>作业成批送入计算机, 然后由作业调度程序自动选择作业, 在系统内(多道)运行</p><ul><li>系统吞吐率高: 脱机/多道运行</li><li>作业周转时间长, 用户使用不方便, <strong>缺少交互性</strong></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="分时系统">分时系统<a class="hash-link" href="#分时系统" title="Direct link to heading">​</a></h4><p>采用时间片(time slice)轮转(round robin)的方法, 使计算机同时为多个终端用户服务, 保证对每个用户都有足够快的响应时间, 并提供交互会话功能</p><ul><li>并行性</li><li>独占性</li><li>交互性</li></ul><p>单处理器系统: 处理器与设备/处理器与通道/通道与通道/设备与设备可以同时刻<strong>并行</strong>(真正意义上的同时进行)</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="实时系统">实时系统<a class="hash-link" href="#实时系统" title="Direct link to heading">​</a></h4><p>实时系统对外部输入的信息, 能够在规定时间内处理完毕并作出反应(实时控制/实时信息处理) e.g 嵌入式操作系统</p><ul><li>可靠性</li><li>安全性</li><li>及时响应</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="操作系统虚拟机">操作系统虚拟机<a class="hash-link" href="#操作系统虚拟机" title="Direct link to heading">​</a></h3><ul><li>在裸机上配置了操作系统后便构成了操作系统虚拟机</li><li>裸机的指令系统: 机器指令; 操作系统虚拟机的指令系统: 系统调用</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="用户接口">用户接口<a class="hash-link" href="#用户接口" title="Direct link to heading">​</a></h4><ul><li>操作/命令接口(操作命令): 作业控制语言/键盘命令(CLI)/图形化用户界面(GUI)</li><li>程序接口(系统功能调用): 在用户程序中可以直接使用系统功能调用(system call)请求操作系统提供的服务</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="操作系统的组织结构">操作系统的组织结构<a class="hash-link" href="#操作系统的组织结构" title="Direct link to heading">​</a></h3><ul><li>一体化结构</li><li>模块化结构</li><li>可扩展内核(微内核)结构</li><li>层次化结构</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="并发">并发<a class="hash-link" href="#并发" title="Direct link to heading">​</a></h3><p>Concurrent</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="程序并发的特点">程序并发的特点<a class="hash-link" href="#程序并发的特点" title="Direct link to heading">​</a></h4><ul><li>程序执行的间断性</li><li>相互通信的可能性</li><li>资源分配的动态性</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="启动">启动<a class="hash-link" href="#启动" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="bios">BIOS<a class="hash-link" href="#bios" title="Direct link to heading">​</a></h3><ul><li>基本输入输出程序</li><li>系统设置信息</li><li>开机后自检程序</li><li>系统自启动程序</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="启动顺序">启动顺序<a class="hash-link" href="#启动顺序" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="寄存器">寄存器<a class="hash-link" href="#寄存器" title="Direct link to heading">​</a></h4><ul><li>CF: 初值 F000H</li><li>EIP: 初值 FFF0H</li></ul><p>(FFF)F0000H+FFF0H = FFFFFFF0H,
BIOS 的 EPROM(Erasable Programmable Read Only Memory) 处
加电后第一条指令一般是 ljmp(实模式下, 内存 !MB), 跳转地址为 CF&lt;&lt;4+EIP, 跳转至 BIOS 例行程序起始点.</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="bios-config">BIOS Config<a class="hash-link" href="#bios-config" title="Direct link to heading">​</a></h4><p>BIOS 根据设置(硬盘/U 盘/网络启动),
加载存储设备的主引导扇区(Master Boot Record)(第一个扇区)的 512 字节至内存 0x7c00 处,
开始执行第一条指令(Boot Loader)</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="boot-loader">Boot Loader<a class="hash-link" href="#boot-loader" title="Direct link to heading">​</a></h4><p>实模式与保护模式带来的问题:</p><ul><li>在实模式的寻址模式中, 令物理地址为 16 位段寄存器左移 4 位加 16 位逻辑地址的偏移所得的 20 位地址</li><li>若要访问 1MB 之后的内存, 则必须开启 A20 Line 开关(关闭 wrap around),
将 32 位地址总线打开, 并进入保护模式(Protect Mode)</li><li>在实模式中, 0~4KB 为中断向量表保留, 640KB ~ 1MB 为显存与 BIOS 保留, 实际可用的内存只有 636KB</li><li>考虑到日后内核镜像的体积有超过 1MB 的可能, 所以将其装载到物理地址 1MB(0x100000) 之后连续的一块内存中更好.</li><li>若要装载内核到物理地址 1MB 之后(实模式下无法访问), 可在实模式中暂时将其装载到一个临时位置, 待进入保护模式之后再移动至合适位置</li></ul><p>解决方案:</p><ul><li>将内核镜像装入内存临时地址</li><li>开启保护模式</li><li>移动内核镜像至 1MB 之后合适位置</li><li>跳转至内核入口(<code>jmp addr</code> 用以修改 cs:eip)</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="标志">标志<a class="hash-link" href="#标志" title="Direct link to heading">​</a></h5><p>lab1/tools/sign.c:</p><ul><li>有效字节小于 510 bytes</li><li>结尾为 0x55aa</li><li>总计字节小于 512 bytes</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="基本功能">基本功能<a class="hash-link" href="#基本功能" title="Direct link to heading">​</a></h5><ul><li>切换到保护模式, 启动段机制</li><li>通过 8042 键盘控制器的端口, 开启 A20, 关闭 memory wrap around, 获取足够内存空间</li></ul><div class="codeBlockContainer_I0IT language-cpp theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-cpp codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 键盘控制器的命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xD0</span><span class="token plain"> Read Output Port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xD1</span><span class="token plain"> Write Output Port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xDD</span><span class="token plain"> Enable A20 Address Line</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xDF</span><span class="token plain"> Disable A20 Address Line</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x60</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 数据端口</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x64</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> 命令端口</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">call  empty_8042</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov   al</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0xd1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">out   </span><span class="token number" style="color:#36acaa">0x64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">call  empty_8042</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mov   al</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">0xdf</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">out   </span><span class="token number" style="color:#36acaa">0x60</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">al</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">call  empty_8042</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">empty_8042</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dw    </span><span class="token number" style="color:#36acaa">00</span><span class="token plain">ebh</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain">ebh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    in    al</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">64</span><span class="token plain">h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    test  al</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    jnz   empty_8042</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li><p>置 cr0 保护模式标志位(bit0) 为 1</p></li><li><p>加载全局描述符表</p></li><li><p>设置各个通用寄存器与段寄存器</p></li><li><p>从硬盘上加载 某种(kernel in ELF) 格式的 os kernel(在硬盘中紧邻 MBR) 至内存的固定区域</p></li><li><p>跳转到 os kernel 的入口点(entry point), 转移控制权至 os</p></li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="保护模式与段机制">保护模式与段机制<a class="hash-link" href="#保护模式与段机制" title="Direct link to heading">​</a></h5><ul><li>CS -&gt; 全局描述符表(其起始地址与表大小位于 gdt 寄存器中)某项(每项存有 base/limit 等信息)
-&gt; 局部描述符表 -&gt; 段选择子(段的基本信息) -&gt; 基址+EIP -&gt; 线性地址 ---页机制---&gt; 物理地址</li><li>将 cr0 寄存器 bit0 置为 1, 表示进入了保护模式, 段机制开始起作用</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="物理内存管理">物理内存管理<a class="hash-link" href="#物理内存管理" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="boot-loader-探测机器内存分布">Boot Loader 探测机器内存分布<a class="hash-link" href="#boot-loader-探测机器内存分布" title="Direct link to heading">​</a></h3><p>为内存管理模块提供基础: 在进入实模式前, 调用 int 15h(88h, e801h, e820h), 借助 BIOS 中断获取内存信息</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="boot-loader-基本概念">Boot Loader 基本概念<a class="hash-link" href="#boot-loader-基本概念" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="boot-loader-基本目标">Boot Loader 基本目标<a class="hash-link" href="#boot-loader-基本目标" title="Direct link to heading">​</a></h4><ul><li>抽象: 逻辑地址空间(线性物理地址映射)</li><li>保护: 独立地址空间(进程间互不影响)</li><li>共享: 访问相同内存(内核空间与共享库)</li><li>虚拟化: 独占内存空间假象</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="基本管理方式">基本管理方式<a class="hash-link" href="#基本管理方式" title="Direct link to heading">​</a></h4><ul><li>重定位(relocation)</li><li>分段(segmentation): 代码段/数据段</li><li>分页(paging)</li><li>虚拟存储(virtual memory): 内存视作硬盘的缓存, 硬盘视作虚拟内存</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="地址生成">地址生成<a class="hash-link" href="#地址生成" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="地址生成时机">地址生成时机<a class="hash-link" href="#地址生成时机" title="Direct link to heading">​</a></h5><ul><li>编译时</li><li>链接时</li><li>加载时</li><li>执行时(相对寻址)</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="地址映射">地址映射<a class="hash-link" href="#地址映射" title="Direct link to heading">​</a></h4><p>软硬件结合:</p><p>逻辑地址 ---&gt; 物理地址</p><ul><li>硬件(CPU/MMU)完成映射地址</li><li>操作系统建立映射规则(页表)</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="地址检查">地址检查<a class="hash-link" href="#地址检查" title="Direct link to heading">​</a></h4><p>软硬件结合:</p><ul><li>操作系统设置的段机制和段长度</li><li>硬件(CPU/MMU)根据段信息进行地址检查(内存访问是否异常)</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="连续内存分配">连续内存分配<a class="hash-link" href="#连续内存分配" title="Direct link to heading">​</a></h3><ul><li>malloc</li><li>free</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="内存碎片">内存碎片<a class="hash-link" href="#内存碎片" title="Direct link to heading">​</a></h4><ul><li>外部碎片: 已分配单元间无法利用空闲单元(请求内存单元过大)</li><li>内部碎片: 已分配单元内空闲单元</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="动态分配策略">动态分配策略<a class="hash-link" href="#动态分配策略" title="Direct link to heading">​</a></h4><ul><li>Fist-fit(最先匹配): 使用第一个可利用空闲块 - 容易产生外部碎片, 分配大块效率低</li><li>Best-fit(最佳匹配): 使用利用度最高的空闲块 - 外部碎片过小, 释放时需重新排列空闲块链表(升序)</li><li>Worst-fit(最差匹配): 使用利用度最差的空闲块 - 分配中块效率高, 释放时需重新排列空闲块链表(降序)</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="碎片整理策略">碎片整理策略<a class="hash-link" href="#碎片整理策略" title="Direct link to heading">​</a></h4><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ucore-实现">ucore 实现<a class="hash-link" href="#ucore-实现" title="Direct link to heading">​</a></h4><ul><li>连续存放 n 个 page 结构, 形式表示内存页, 并在连续内存块的首页(header page)保存此连续块的连续页数目</li><li>维护一个链表, 链表每项为大块连续内存块的起始页(header page address) 和 连续页数目, 管理分散的连续内存块</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="紧凑">紧凑<a class="hash-link" href="#紧凑" title="Direct link to heading">​</a></h5><p>Compaction, 将不同进程占用内存单元移至较为集中的地方:</p><ul><li>只可移动 可动态重定位程序</li><li>只可移动 等待状态进程</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="分区对换">分区对换<a class="hash-link" href="#分区对换" title="Direct link to heading">​</a></h5><p>Swapping In and Swapping Out:</p><p>将等待状态进程的分区对换至外存,以增大可用内存单元</p><blockquote><p>e.g Linux Swap 分区: 安装系统时一般切割大小为内存大小的 50%~100% 的外存作为 Swap 分区</p></blockquote><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="malloc-实现策略">Malloc 实现策略<a class="hash-link" href="#malloc-实现策略" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="启发式编程">启发式编程<a class="hash-link" href="#启发式编程" title="Direct link to heading">​</a></h5><p>Heuristic Programming:</p><ul><li>建立已分配 void 指针表,free 函数执行时,只回收表中存在的指针;不存在则报错</li><li>对 heap 进行分区 - 小/中/大块内存请求,分别从不同区域(8/16/32 最小单位区)分配</li><li>记录当前堆块的信息，如长度，空闲状态</li><li>记录周围环境信息，如保留上/下一堆块的指针或记录上/下堆块空闲状态</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="伙伴系统">伙伴系统<a class="hash-link" href="#伙伴系统" title="Direct link to heading">​</a></h5><p>Buddy System:</p><ul><li>可分配内存单元总大小为 2^n</li><li>总是将大小 <strong>小于</strong>请求大小的<strong>2 倍</strong>且为<strong>2 的幂次方</strong> 的某块内存单元分配出去(大小为 2^(i-1))</li></ul><h6 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="合并空闲块">合并空闲块<a class="hash-link" href="#合并空闲块" title="Direct link to heading">​</a></h6><ul><li>空闲块相邻</li><li>空闲块等大</li><li>低地址空闲块的 起始地址 必须为 空闲块大小 的 2 的幂次方倍(2 倍以上)</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="非连续内存分配">非连续内存分配<a class="hash-link" href="#非连续内存分配" title="Direct link to heading">​</a></h3><ul><li>支持一个程序使用非连续的物理地址空间</li><li>支持共享代码与数据</li><li>支持动态加载与动态链接</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="段式存储管理">段式存储管理<a class="hash-link" href="#段式存储管理" title="Direct link to heading">​</a></h4><p>将逻辑地址划分, 低位表示段内偏移, 高位(取摸)表示段号(类比缓存中的内存地址)</p><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="gdt">GDT<a class="hash-link" href="#gdt" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-cpp theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-cpp codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">gdt_ptr</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> gdt_limit</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// gdt_length - 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> gdt_base</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> gdt_ptr_t</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>用 16 位来表示表的长度(2 ^ 16 = 65532 bytes), 除以每一个描述符的 8 字节, 最多能创建 8192 个描述符</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="页式存储管理">页式存储管理<a class="hash-link" href="#页式存储管理" title="Direct link to heading">​</a></h4><p>开启页机制:</p><ul><li>init page directory(首址位于 cr3 寄存器), page table</li><li>update GDT</li><li>update ds,es,ss</li><li>update cs with jmp instruction</li><li>cr0 寄存器 bit31(most bit) 置 1</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="虚拟地址">虚拟地址<a class="hash-link" href="#虚拟地址" title="Direct link to heading">​</a></h5><p>TLB (Translation Lookaside Buffer in CPU/PM):</p><ul><li>Virtual Address =
<code>2^(bits of virtual page offset) * virtual page number + virtual page offset</code>.</li><li>VA = VPN (virtual page number point to PPN) + VPO(virtual page offset = PPO).</li><li>根据 VPN 在页表中找到对应表项(VPN 表示项号), 每项保存着 PPN.</li><li>TLB = TLBT (tag) + TLBI(index) + VPO.</li><li>因为内存局部性原理, TLB 一般只需要很小 (比如 <strong>64 项</strong>) 即可达到不错的效果.</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="物理地址">物理地址<a class="hash-link" href="#物理地址" title="Direct link to heading">​</a></h5><p>C(cache) PPO = VPO:</p><ul><li>Page Frame (帧): 高位为帧号, 低位为偏移.</li><li>Physical Address =
<code>2^(bits of phy page offset) * phy page/frame frame number + phy page offset</code></li><li>PA = PPN (physical page number) + PPO (physical page offset = VPO).</li><li>CA = CT(tag) + CI(index) + CO(offset).</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="页表">页表<a class="hash-link" href="#页表" title="Direct link to heading">​</a></h5><ul><li>页表由操作系统建立, 硬件(CPU/MMU)根据页表信息将虚拟地址映射为物理地址</li></ul><h6 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="页表结构">页表结构<a class="hash-link" href="#页表结构" title="Direct link to heading">​</a></h6><ul><li>FN/PPN</li><li>标志位: resident bit(存在位)/dirty bit(修改位)/reference(clock) bit(引用位)</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="性能问题">性能问题<a class="hash-link" href="#性能问题" title="Direct link to heading">​</a></h5><ul><li>两次访存: 第一次获取页表项, 第二次访问实际数据</li><li>页表占据大量内存单元</li></ul><h6 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tlb">TLB<a class="hash-link" href="#tlb" title="Direct link to heading">​</a></h6><p>Translation Lookaside Buffer:</p><p>缓存页表项 - key: VPN, value: PPN 　不用访问页表</p><h6 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="多级页表">多级页表<a class="hash-link" href="#多级页表" title="Direct link to heading">​</a></h6><ul><li>切割页表: 建立子页表</li><li>Page Directory -&gt; Page Table -&gt; Physical Address</li><li>将线性地址分成三部分 Directory+Table+Offset:
cr3+Dir 取出 page table base,
ptb+Tab 取出 physical address base, pab+offset = pa</li></ul><blockquote><p>CR3 寄存器: 保存一级页表的基址</p></blockquote><ul><li>父页表表项保存子页表起始地址, 逻辑地址某部分保存偏移地址(子表项号)</li><li>存在位为 0 时, 不用保存子表, 节省内存单元</li></ul><h6 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="反置页表">反置页表<a class="hash-link" href="#反置页表" title="Direct link to heading">​</a></h6><ul><li>PPN 作为页表索引, 页表项保存 VPN(或者 Hash(VPN|PID))</li><li>将 VPN 映射为 PPN 时, 需遍历整个页表(但此页表只占用少量内存单元)</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="段页式存储管理">段页式存储管理<a class="hash-link" href="#段页式存储管理" title="Direct link to heading">​</a></h4><p>在页式存储管理基础上, 引入段式存储管理</p><p><code>&lt;--- vsn --- vpn --- vpo ---&gt;</code> 映射为 <code>&lt;--- ppn --- ppo ---&gt;</code></p><blockquote><p>sn: segment number, pn:page number, po: page offset</p></blockquote><p>若以 4K(limit) 为 1 个页表大小, 则下级页表首址为 <code>段/页表中某项的值 &lt;&lt; 12</code>(2^12 = 4K)</p><ul><li>以 vsn 为索引在进程段表中找到段表项, 获取段(页表)基址与段大小信息(item_value/limit): base = item_value &lt;&lt; log2(limit)</li><li>以 vpn 为索引在进程页表(页表基址 = base 中找到页表项, 获取 ppn</li><li>ppn &lt;&lt; log2(limit) + vpo(ppo) 为实际物理地址</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="内存的特权级">内存的特权级<a class="hash-link" href="#内存的特权级" title="Direct link to heading">​</a></h3><p>0: 最高特权级, 3: 最低特权级</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="特权级检查">特权级检查<a class="hash-link" href="#特权级检查" title="Direct link to heading">​</a></h4><ul><li>CPL/RPL: 访问者特权级</li><li>DRL: 段描述符/门描述符(中断/陷阱门)中保存的特权级, 表示被访问段/中断服务/陷阱的特权级</li><li>CPL/RPL &lt;= DRL e.g 0 &lt; 3</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="特权级切换">特权级切换<a class="hash-link" href="#特权级切换" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ring-0-to-ring-3">Ring 0 to Ring 3<a class="hash-link" href="#ring-0-to-ring-3" title="Direct link to heading">​</a></h5><ul><li>interrupt/trap: push SS(<strong>RPL=3</strong>) -&gt; ESP -&gt; EFLAGS
-&gt; CS(<strong>RPL=3</strong>) -&gt; EIP -&gt; Error Code</li><li>iret: pop above variables, move to ring 3</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="ring-3-to-ring-0">Ring 3 to Ring 0<a class="hash-link" href="#ring-3-to-ring-0" title="Direct link to heading">​</a></h5><p>特权级提升:</p><ul><li>interrupt/trap: stack switch</li><li>push EFLAGS -&gt; CS(<strong>RPL=0</strong>) -&gt; EIP -&gt; Error Code</li><li>iret: pop above variables, move to ring 0</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tss">TSS<a class="hash-link" href="#tss" title="Direct link to heading">​</a></h4><p>Task State Segment:</p><p>保存不同特权级的堆栈信息(SS/ESP)</p><p>全局描述符表中保存一个 TSS Descriptor(TSS base + TSS limit):
allocate TSS memory -&gt; init TSS
-&gt; fill TSS descriptor in GDT -&gt; set TSS selector(task register)</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="虚拟内存管理">虚拟内存管理<a class="hash-link" href="#虚拟内存管理" title="Direct link to heading">​</a></h2><p>虚拟内存 = 物理内存 + 外存</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="page-fault">Page Fault<a class="hash-link" href="#page-fault" title="Direct link to heading">​</a></h3><ul><li>虚拟地址越界: 访问不存在的虚拟地址</li><li>对只读地址进行写操作</li><li>访问未映射虚拟页(swap in/out)</li><li>CPU 将产生异常的的线性地址(linear address) 存储在 CR2 寄存器中, 将 errorCode(bit2-访问权限异常,bit1-写异常,bit0-物理页不存在)压入中断栈</li></ul><blockquote><p>CR0: 处理器模式(实/保护/分段/分页模式);
CR2: Page Fault Linear Address;
CR3: Page-Directory Base Address Register</p></blockquote><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="覆盖与交换">覆盖与交换<a class="hash-link" href="#覆盖与交换" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="覆盖技术">覆盖技术<a class="hash-link" href="#覆盖技术" title="Direct link to heading">​</a></h4><p>Overlay:</p><p>将程序中相互独立的模块分成一组, 为每组按最大模块分配内存单元</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="交换技术">交换技术<a class="hash-link" href="#交换技术" title="Direct link to heading">​</a></h4><p>Swap:</p><p>将挂起进程的整个地址空间换出至外存(swap out), 将需用进程的整个地址空间换入至内存(swap in), 进程交替运行</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="虚拟页式存储管理">虚拟页式存储管理<a class="hash-link" href="#虚拟页式存储管理" title="Direct link to heading">​</a></h3><ul><li>只将运行进程所必需页面装入内存, 其余页面至于外存</li><li>进程发生缺页异常时, 将所要求缺页装入内存:
选择目标物理页面 -&gt; 无未占用物理页面, 则换出闲置物理页面(访问位)
-&gt; 装入物理内存,更新页表项
(换入逻辑地址与换出逻辑地址对应的页表项的驻留位/修改位/访问位/锁定位以及物理页号 ppn)</li><li>监控已经装入内存的页面, 及时将不需要页面换出至外存</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="标志位">标志位<a class="hash-link" href="#标志位" title="Direct link to heading">​</a></h4><ul><li>驻留位: 此逻辑地址对应的页面在内存中</li><li>修改位: 此页面是否被修改过, 判定此页面换出时策略(写回外存/直接丢弃)</li><li>访问位: 此页面是否被读/写过, 判定此页面是否需要换出至外存</li><li>锁定位: 此页面不会被换出</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="页面置换算法">页面置换算法<a class="hash-link" href="#页面置换算法" title="Direct link to heading">​</a></h4><p>当出现缺页异常且物理内存已满时, 需要以页面置换算法为指导, 换出闲置物理页面, 换入所要求缺页, 并更新页表项:</p><ul><li>尽可能减少物理页面的换入换出次数</li><li>只可交换映射到用户空间的物理页</li><li>当页表项中 <code>PTE_P</code> 为 0 时, 对应高位地址表示扇区地址(而不是物理位移)</li><li>换入时机: Page Fault 缺页; 换出时机: 积极/消极换出策略</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="局部置换算法">局部置换算法<a class="hash-link" href="#局部置换算法" title="Direct link to heading">​</a></h5><p>换入进程 A 的某个页面时, 只可换出进程 A 的某个页面: 为进程分配固定数目的页面</p><h6 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="最远未用算法">最远未用算法<a class="hash-link" href="#最远未用算法" title="Direct link to heading">​</a></h6><p>Least Recently Used (LRU) Algorithm:</p><ul><li>利用<strong>链表等线性结构</strong>维护页面访问时间, 队首为最近一次访问页面(每次访问一个页面后, 把它从线性结构中间抽出至队首), 队尾为最远一次访问页面</li></ul><h6 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="时钟算法">时钟算法<a class="hash-link" href="#时钟算法" title="Direct link to heading">​</a></h6><p>Clock Algorithm:</p><ul><li>利用<strong>循环链表</strong>维护页面(指针指向最先换入内存的页面), 页表项访问位维护访问记录(访问后将访问位置 1)</li><li>缺页时, 从指针处开始查找页面进行置换: 若访问位为 0, 则进行置换; 若访问位为 1, 则将此页面访问位置 0, 继续查找未访问页面</li><li>改进: 增加修改位</li></ul><table><thead><tr><th align="left">指针扫描前</th><th align="left">指针扫描后</th></tr></thead><tbody><tr><td align="left">访问位 修改位</td><td align="left">访问位 修改位</td></tr><tr><td align="left">0 0</td><td align="left">置换</td></tr><tr><td align="left">0 1</td><td align="left">0 0</td></tr><tr><td align="left">1 0</td><td align="left">0 0</td></tr><tr><td align="left">1 1</td><td align="left">0 1</td></tr></tbody></table><h6 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="最不常用算法">最不常用算法<a class="hash-link" href="#最不常用算法" title="Direct link to heading">​</a></h6><p>Least Frequently Used (LFU) Algorithm:</p><ul><li>利用<strong>链表等线性结构</strong>维护页面访问时间, 队首为最多访问次数页面(每次访问一个页面后, 访问次数+1, 并排序), 队尾为最少访问次数页面</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="全局置换算法">全局置换算法<a class="hash-link" href="#全局置换算法" title="Direct link to heading">​</a></h5><ul><li>换入进程 A 的某个页面时, 可换出其他进程的某个页面: 为进程分配可变数目的页面</li><li>关键: 确定为不同进程分配的页面数目</li><li>抖动(thrashing): 进程过多, 导致大部分进程的常驻集&lt;工作集, 缺页率较高</li></ul><h6 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="工作集算法">工作集算法<a class="hash-link" href="#工作集算法" title="Direct link to heading">​</a></h6><ul><li>工作集(随时间动态变化集): 一个进程当前正在使用的逻辑页面集合,
WorkingSet(currentTime, workingSetWindow(访问时间窗口)) <code>(cT - wSW, cT + wSW)</code></li><li>根据工作集大小(逻辑页面集合), 为该进程分配常驻集(合适数目的物理页面集合): 若常驻集 &gt; 工作集, 则缺页率较低</li><li>再额外维护一个类希 LRU 算法中的访存链表, 记录近期访问过的物理页面, 将其也加入常驻集</li></ul><h6 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="缺页率算法">缺页率算法<a class="hash-link" href="#缺页率算法" title="Direct link to heading">​</a></h6><p>当缺页频繁时, 缺页时将缺页的页面加入常驻集; 当缺页不频繁时, 缺页时将不属于工作集的页面移出常驻集</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="实现">实现<a class="hash-link" href="#实现" title="Direct link to heading">​</a></h4><ul><li>为每个进程分配一个 vma 块, 模拟一个完整的物理内存</li><li>vmas 按起始<strong>地址从小至大</strong>形成一个双向链表, 且地址空间<strong>没有任何交集</strong></li></ul><div class="codeBlockContainer_I0IT language-cpp theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-cpp codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">VM_READ</span><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression number" style="color:#36acaa">0x00000001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">VM_WRITE</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression number" style="color:#36acaa">0x00000002</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">VM_EXEC</span><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression number" style="color:#36acaa">0x00000004</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">VM_USER</span><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression punctuation" style="color:#393A34">(</span><span class="token macro property expression" style="color:#36acaa">VM_READ </span><span class="token macro property expression operator" style="color:#393A34">|</span><span class="token macro property expression" style="color:#36acaa"> VM_WRITE </span><span class="token macro property expression operator" style="color:#393A34">|</span><span class="token macro property expression" style="color:#36acaa"> VM_EXEC</span><span class="token macro property expression punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">__mm</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    list_entry_t mmap_list</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// header of vmas&#x27; list</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vma </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mmap_cache</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// current accessed vma(used for speed purpose)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pde_t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pgdir</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// PDT for vmas</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> map_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// count of vmas</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sm_priv</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// private data for swap manager</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> mm</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">__vma</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">mm</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vm_mm</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// all vmas use the same PDT(page directory table)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uintptr_t vm_start</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// start address of vma (align to PGSIZE)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uintptr_t vm_end</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// end address of vma   (align to PGSIZE)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> vm_flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// flags of vma</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    list_entry_t vma_list</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// doubly linked list: sort all vmas by start address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> vma</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="中断">中断<a class="hash-link" href="#中断" title="Direct link to heading">​</a></h2><p>Interrupt Service Routine/Interrupt Quest:</p><ul><li>NMI 中断(Non Maskable Interrupt) 与 INTR 中断(可屏蔽中断)</li><li>x86PC 中断控制芯片: 8259A PIC</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="中断进入">中断进入<a class="hash-link" href="#中断进入" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="保护现场">保护现场<a class="hash-link" href="#保护现场" title="Direct link to heading">​</a></h4><ul><li>push PSW(Program State Word): (cs:eip + eflags)</li><li>push PC(Program Counter)</li><li>中断向量表(将中断向量表对应的中断的 PSW(高 2 字节) 与 PC(低 2 字节) 先后替换原 PSW 与 PC)</li><li>系统堆栈</li><li>中断屏蔽码: n 位 2 进制数(n 为中断总数), 允许响应 n 号中断则该位置 1</li></ul><p>程序状态字:</p><ul><li>当前执行指令(eip)</li><li>当前指令执行情况</li><li>处理机所处状态</li><li>中断屏蔽码(程序在执行时应屏蔽的中断)</li><li>寻址方法/编址/保护键</li><li>响应中断的内容</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="中断实现">中断实现<a class="hash-link" href="#中断实现" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="概述">概述<a class="hash-link" href="#概述" title="Direct link to heading">​</a></h4><ul><li>硬件发生了某个事件后告诉中断控制器(PIC), 中断控制器汇报给 CPU</li><li>CPU 从中断控制器处获取中断号, 根据中断号调用对应中断服务例程</li><li>处理完成后重新回到之前的执行流程</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="interrupt-实现">Interrupt 实现<a class="hash-link" href="#interrupt-实现" title="Direct link to heading">​</a></h4><ul><li>发生中断, PIC 报告中断号给 CPU</li><li>CPU 调用对应处理程序 irsr_x/irq_x</li><li>irsr_x/irq_x 负责压入相关信息(中断号/错误码), 然后跳转至统一处理函数 <code>common_stub</code></li><li><code>common_stub</code>: 压栈 -&gt; 调用 fault_handler/req_handler -&gt; 出栈</li><li>进入 handler 后, 再根据中断号/错误码(结构体)以及栈帧信息(结构体), 进行实际处理(真正处理逻辑)</li><li>在进入 handler 之前, 都是通过汇编代码进行最简单的处理(压入相关信息), 将实际中断处理逻辑放在 C 语言中, 再辅以内联汇编, 可大大地提升中断处理程序的编写效率以及中断处理程序的处理能力</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="系统调用">系统调用<a class="hash-link" href="#系统调用" title="Direct link to heading">​</a></h3><ul><li>保护系统安全, 提升可靠性与安全性</li><li>调用: 用户态, 执行: 管态/内核态</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="进程">进程<a class="hash-link" href="#进程" title="Direct link to heading">​</a></h2><p>资源分配单位:</p><ul><li>独立性: 无副作用(确定性), 可重现</li><li>并发性(宏观并行, 微观串行): 提升效率, 共享资源, 高度模块化</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="进程特权级">进程特权级<a class="hash-link" href="#进程特权级" title="Direct link to heading">​</a></h3><ul><li>处理机的态/处理机的特权级: 根据对资源和机器指令的使用权限, 将处理执行时的工作状态区分为不同的状态</li><li>管理(supervisor mode)/系统态: 使用全部机器指令(包括特权指令), 可使用所有资源, 允许访问整个内存区, 运行系统程序</li><li>用户态: 禁止使用特权指令(I/O 设备指令, 直接修改特殊寄存器指令, 改变机器状态指令),
不可<strong>直接</strong>取用资源与改变机器状态, 只可访问自己的存储区域, 运行用户程序</li><li>用户态切换至管态: 错误/异常状态(除 0/缺页), 外部中断(I/O), 系统调用, 这一过程是由<strong>硬件完成</strong>的</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="进程状态与生命周期">进程状态与生命周期<a class="hash-link" href="#进程状态与生命周期" title="Direct link to heading">​</a></h3><p>创建, 就绪(ready), 运行(running), 等待(wait/sleeping),
挂起(suspend: 进程由内存换出至外存), 结束(抢占, 唤醒):
进程优先级与剩余内存单元在一定程度上会影响进程状态</p><ul><li>进程首先在 cpu 初始化或者 sys_fork 的时候被创建,当为该进程分配了一个进程控制块之后,该进程进入 uninit 态</li><li>当进程完全完成初始化之后,该进程转为 runnable 态</li><li>当到达调度点时,由调度器 sched_class 根据运行队列 rq 的内容来判断一个进程是否应该被运行,
即把处于 runnable 态的进程转换成 running 状态,从而占用 CPU 执行</li><li>running 态的进程通过 wait 等系统调用被阻塞,进入 sleeping 态</li><li>sleeping 态的进程被 wake up 变成 runnable 态的进程</li><li>running 态的进程主动 exit 变成 zombie 态, 然后由其父进程完成对其资源的最后释放,子进程的进程控制块成为 unused</li><li>所有从 runnable 态变成其他状态的进程都要出运行队列(dequeue), 反之，被放入某个运行队列中(enqueue)</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="进程控制块">进程控制块<a class="hash-link" href="#进程控制块" title="Direct link to heading">​</a></h4><p>Process Control Block:</p><p>通过组织管理 PCB(链表/索引表) 来组织管理进程; 在进程创建/终止的同时, 生成/回收改进程的 PCB:</p><ul><li>进程信息: 名字/pid/uid</li><li>链表信息: 父进程指针/所属队列指针(就绪队列/IO 等待队列/挂起队列)</li><li>CPU 调度/运行时信息: eflags/cr3/状态</li><li>内存资源信息: 堆指针/栈指针/虚拟内存页面指针</li><li>上下文信息(用于进程/上下文切换时保存/恢复上下文): trap frame/context(register files)</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="进程通信">进程通信<a class="hash-link" href="#进程通信" title="Direct link to heading">​</a></h3><ul><li>直接通信: send(proc, msg), receive(proc, msg) <code>shmctl() shm*</code></li><li>间接通信: send(msg_que, msg), receive(msg_que, msg) <code>msgctl() msg*</code></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="线程">线程<a class="hash-link" href="#线程" title="Direct link to heading">​</a></h3><p>CPU 调度单位:</p><ul><li>进程缺陷: 共享数据不便, 系统开销大</li><li>线程共享段表/共享库/数据/代码/环境变量/文件描述符集合/地址空间, 但拥有独立的堆/栈/通用寄存器</li><li>线程控制块(Thread Control Block)</li><li>用户线程与内核线程: 多为 1 对 1</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="idle-process">IDLE Process<a class="hash-link" href="#idle-process" title="Direct link to heading">​</a></h4><p>0 号内核线程:</p><ul><li>工作就是不停地查询，直至有其他内核线程处于就绪状态, 令调度器执行那个内核线程</li><li>IDLE 内核线程是在操作系统没有其他内核线程可执行的情况下才会被调用</li><li>在所有进程中，只有 IDLE (内核创建的第一个内核线程) 没有父进程</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="内核线程与用户进程">内核线程与用户进程<a class="hash-link" href="#内核线程与用户进程" title="Direct link to heading">​</a></h3><ul><li>内核线程只运行在内核态</li><li>用户进程会交替运行在用户态和内核态(系统调用/外设中断/异常中断)</li><li>所有内核线程直接使用共同的内核内存空间, 拥有相同的内核虚拟地址空间(包括物理地址空间)</li><li>每个用户进程拥有单独的用户内存空间(虚拟内存单元)</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="process-实现">Process 实现<a class="hash-link" href="#process-实现" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="process-context">Process Context<a class="hash-link" href="#process-context" title="Direct link to heading">​</a></h4><p>执行现场/执行上下文:</p><ul><li>设置好执行现场后, 一旦调度器选择了 initproc 执行, 就需要根据 initproc-&gt;context 中保存的执行现场来恢复 initproc 的执行</li><li>通过 proc_run 和进一步的 switch_to 函数完成两个执行现场的切换，具体流程如下:<ul><li>让 current 指向 next 内核线程 initproc</li><li>设置任务状态段 ts 中特权态 0 下的栈顶指针 esp0 为 next 内核线程 initproc 的内核栈的栈顶,
即 next-&gt;kstack + KSTACKSIZE</li><li>设置 CR3 寄存器的值为 next 内核线程 initproc 的页目录表起始地址 next-&gt;cr3</li><li>由 switch_to 函数完成具体的两个线程的执行现场切换, 即切换各个寄存器</li></ul></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="process-fork-function">Process Fork Function<a class="hash-link" href="#process-fork-function" title="Direct link to heading">​</a></h4><ul><li>分配并初始化进程控制块(alloc_proc 函数)</li><li>分配并初始化内核栈(setup_stack 函数)</li><li>根据 clone_flag 标志复制或共享进程内存管理结构(copy_mm 函数)</li><li>设置进程在内核(或用户态)正常运行和调度所需的中断帧和执行上下文(copy_thread 函数)</li><li>把设置好的进程控制块放入 hash_list 和 proc_list 两个全局进程链表中</li><li>把进程状态设置为“就绪”态</li><li>设置返回码为子进程的 id 号</li></ul><p>fork() 的主要行为:</p><ul><li>申请 pid 与进程结构</li><li>设置 ppid 为父进程的 pid</li><li>复制用户相关的字段, 如 p_pgrp/p_gid/p_ruid/p_euid/p_rgid/p_egid</li><li>复制调度相关的字段, 如 p_cpu/p_nice/p_pri</li><li>复制父进程的文件描述符 (p_ofile), 并增加引用计数</li><li>复制父进程的信号处理例程 (p_sigact)</li><li>通过 vm_clone(), 复制父进程的地址空间(p_vm)</li><li>复制父进程的寄存器状态 (p_context)</li><li>复制父进程的中断上下文, 并设置 tf-&gt;eax 为 0, 使 fork()在子进程中返回 0。</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="execution-function">Execution function<a class="hash-link" href="#execution-function" title="Direct link to heading">​</a></h4><p>exec() 的主要行为:</p><ul><li>读取文件的第一个块, 检查 Magic Number 是否正确</li><li>保存参数(argv)到临时分配的几个物理页, 其中的每个字符串单独一页</li><li>清空旧的进程地址空间(vm_clear()), 并结合可执行文件的 header, 初始化新的进程地址空间(vm_renew())</li><li>将 argv 与 argc 压入新地址空间中的栈</li><li>释放临时存放参数的几个物理页</li><li>关闭带有 FD_CLOEXEC 标识的文件描述符</li><li>清理信号处理例程</li><li>通过<code>_retu()</code>返回用户态</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="处理机调度">处理机调度<a class="hash-link" href="#处理机调度" title="Direct link to heading">​</a></h2><p>Schedule:</p><ul><li>从就绪队列中挑选下一个占用 CPU 的进程(挑选进程的内核函数)</li><li>从多个可用 CPU 中挑选使用 CPU 资源</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="调度时机">调度时机<a class="hash-link" href="#调度时机" title="Direct link to heading">​</a></h3><ul><li>进程停止运行, 进入等待/挂起/终止状态</li><li>进程的中断请求完成时, 由等待状态进入就绪状态, 准备抢占 CPU 资源(准备从内核态返回用户态)</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="六大调度时机">六大调度时机<a class="hash-link" href="#六大调度时机" title="Direct link to heading">​</a></h4><ul><li>proc.c::do_exit 用户线程执行结束,主动放弃 CPU 控制权</li><li>proc.c::do_wait 用户线程等待子进程结束,主动放弃 CPU 控制权</li><li>proc.c::init_main<ul><li>initproc 内核线程等待所有用户进程结束,如果没有结束,就主动放弃 CPU 控制权</li><li>initproc 内核线程在所有用户进程结束后,让 kswapd 内核线程执行 10 次，用于回收空闲内存资源</li></ul></li><li>proc.c::cpu_idle idleproc 内核线程的工作就是等待有处于就绪态的进程或线程,如果有就调用 schedule 函数</li><li>sync.h::lock 在获取锁的过程中,如果无法得到锁,则主动放弃 CPU 控制权</li><li>trap.c::trap 如果在当前进程在用户态被打断,且当前进程控制块的成员变量 need_resched 设置为 1,则当前线程会放弃 CPU 控制权</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="调度策略">调度策略<a class="hash-link" href="#调度策略" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="算法目标">算法目标<a class="hash-link" href="#算法目标" title="Direct link to heading">​</a></h4><ul><li>CPU 有效使用率</li><li>吞吐量 (高带宽): 单位时间内完成进程数量</li><li>等待时间 (低延迟): 进程在就绪队列等待总时间</li><li>周转时间 (低延迟): 进程从初始化到结束总时间</li><li>响应时间 (低延迟): 从提交请求到产生响应总时间</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="先来先服务算法">先来先服务算法<a class="hash-link" href="#先来先服务算法" title="Direct link to heading">​</a></h4><p>First Come First Served (FCFS):</p><ul><li>依次执行就绪队列中的各进程(先进入就绪队列先执行)</li><li>CPU 利用率较低</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="短进程优先算法">短进程优先算法<a class="hash-link" href="#短进程优先算法" title="Direct link to heading">​</a></h4><p>Shortest Process Next/Shortest Remaining Time:</p><ul><li>优先执行周转耗时/剩余耗时最短的进程</li><li>若短进程过多, 则导致长进程一直无法执行</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="最高响应比优先算法">最高响应比优先算法<a class="hash-link" href="#最高响应比优先算法" title="Direct link to heading">​</a></h4><p>Highest Response Ratio Next:</p><ul><li>R = (waitTime + serviceTime) / serviceTime: 已等待时间越长, 优先级上升</li><li>修正短进程优先算法的缺点</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="时间片轮转算法">时间片轮转算法<a class="hash-link" href="#时间片轮转算法" title="Direct link to heading">​</a></h4><p>Round Robin:</p><ul><li>在 FCFS 基础上, 设定一个基本时间单元, 每经过一个时间单元, 轮转至下一个先到进程(并进行循环轮转)</li><li>额外的上下文切换</li><li>时间片合适大小: 10 ms</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="多级队列调度算法">多级队列调度算法<a class="hash-link" href="#多级队列调度算法" title="Direct link to heading">​</a></h4><p>MQ:</p><ul><li>将就绪队列分成多个独立子队列, 每个队列可采取不同调度算法</li><li>前台交互队列使用时间片轮转算法, 后台 IO 队列使用先来先服务算法</li><li>队列间使用时间片轮转算法</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="多级反馈队列算法">多级反馈队列算法<a class="hash-link" href="#多级反馈队列算法" title="Direct link to heading">​</a></h4><p>MLFQ:</p><ul><li>优先级高的子队列时间片小, 优先级低的子队列时间片大</li><li>CPU 密集型进程(耗时高)优先级下降很快</li><li>IO 密集型进程(耗时低)停留在高优先级</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="同步互斥">同步互斥<a class="hash-link" href="#同步互斥" title="Direct link to heading">​</a></h2><ul><li>互斥 (Mutual Exclusion)</li><li>死锁 (Deadlock)</li><li>饥饿 (Starvation)</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="临界区的访问原则">临界区的访问原则<a class="hash-link" href="#临界区的访问原则" title="Direct link to heading">​</a></h3><ul><li>空闲则入</li><li>忙则等待</li><li>有限等待</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="基于软件方法的同步互斥">基于软件方法的同步互斥<a class="hash-link" href="#基于软件方法的同步互斥" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT language-cpp theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-cpp codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> turn</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 表示谁该进入临界区</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 表示进程是否准备好进入临界区</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-cpp theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-cpp codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 对于 2 个线程的情况</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Peterson Algorithm</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 线程 i</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flag</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">turn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> j</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 后设置 turn 标志的进程不可进入临界区, 会在 while 循环进行等待</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flag</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">j</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> turn </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> j</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token comment" style="color:#999988;font-style:italic">// critical section</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flag</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-cpp theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-cpp codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Dekkers Algorithm</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 线程 i</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">turn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">flag</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">do</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  flag</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">flag</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">j</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">turn </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      flag</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">turn </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      flag</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// critical section</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  turn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> j</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  flag</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="高级抽象的同步互斥">高级抽象的同步互斥<a class="hash-link" href="#高级抽象的同步互斥" title="Direct link to heading">​</a></h3><p>利用原子操作实现互斥数据结构</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="lock-and-semaphore">Lock and Semaphore<a class="hash-link" href="#lock-and-semaphore" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-cpp theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-cpp codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">lock</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">semaphore </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> locked</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> n</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// n: 并发数/可用资源数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  wait_queue q</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> acquire</span><span class="token operator" style="color:#393A34">/</span><span class="token function" style="color:#d73a49">prolaag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    locked</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sem</span><span class="token operator" style="color:#393A34">--</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">locked</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sem </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sleep_and_enqueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">this_thread</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> release</span><span class="token operator" style="color:#393A34">/</span><span class="token function" style="color:#d73a49">verhoog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    locked</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sem</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">locked</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sem </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">wakeup_and_dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">other_thread</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="monitor">Monitor<a class="hash-link" href="#monitor" title="Direct link to heading">​</a></h4><ul><li>与 semaphore 相反, 初始 0, <code>wait(++ &amp;&amp; sleep)</code>, <code>signal(-- &amp;&amp; wakeup)</code></li><li>管程内可以中断执行, 并 notify 其他等待线程</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="死锁">死锁<a class="hash-link" href="#死锁" title="Direct link to heading">​</a></h3><p>非抢占持有互斥循环等待</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="mutex-实现">Mutex 实现<a class="hash-link" href="#mutex-实现" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="prolaag-and-verhoog">Prolaag and Verhoog<a class="hash-link" href="#prolaag-and-verhoog" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="prolaag-semaphore">Prolaag Semaphore<a class="hash-link" href="#prolaag-semaphore" title="Direct link to heading">​</a></h5><ul><li>关中断</li><li>判断当前信号量的 value 是否大于 0</li><li>如果是&gt;0，则表明可以获得信号量，故让 value 减一，并打开中断返回</li><li>如果不是&gt;0，则表明无法获得信号量，故需要将当前的进程加入到等待队列中，并打开中断，然后运行调度器选择另外一个进程执行</li><li>如果被 V 操作唤醒，则把自身关联的 wait 从等待队列中删除（此过程需要先关中断，完成后开中断）</li></ul><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="verhoog-semaphore">Verhoog Semaphore<a class="hash-link" href="#verhoog-semaphore" title="Direct link to heading">​</a></h5><ul><li>关中断</li><li>如果信号量对应的 wait queue 中没有进程在等待，直接把信号量的 value 加一，然后开中断返回</li><li>如果有进程在等待且进程等待的原因是 semaphore 设置的,
则调用 wakeup_wait 函数将 wait queue 中等待的第一个 wait 删除,
且把此 wait 关联的进程唤醒, 最后开中断返回</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="管程">管程<a class="hash-link" href="#管程" title="Direct link to heading">​</a></h4><p>管程由四部分组成：</p><ul><li>管程内部的共享变量(mutex): 一个二值信号量，是实现每次只允许一个进程进入管程的关键元素，确保了互斥访问性质</li><li>管程内部的条件变量: 通过执行 wait_cv,会使得等待某个条件 C 为真的进程能够离开管程并睡眠，且让其他进程进入管程继续执行;
而进入管程的某进程设置条件 C 为真并执行 signal_cv 时，能够让等待某个条件 C 为真的睡眠进程被唤醒，从而继续进入管程中执行</li><li>管程内部并发执行的进程</li><li>对局部于管程内部的共享数据设置初始值的语句</li><li>成员变量信号量 next: 配合进程对条件变量 cv 的操作而设置的, 由于发出 signal_cv 的进程 A 会唤醒睡眠进程 B,
进程 B 执行会导致进程 A 睡眠，直到进程 B 离开管程，进程 A 才能继续执行，这个同步过程是通过信号量 next 完成</li><li>整形变量 next_count: 表示由于发出 signal_cv 而睡眠的进程个数</li></ul><div class="codeBlockContainer_I0IT language-cpp theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-cpp codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">monitor</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// the mutex lock for going into the routines in monitor,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// should be initialized to 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    semaphore_t mutex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// the next semaphore is used to down the signaling proc itself,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// and the other OR woke up</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    semaphore_t next</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> next_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// the number of of sleepy signaling</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proc condvar_t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">cv</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// the conditional variable in monitor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> monitor_t</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="conditional-variable">Conditional Variable<a class="hash-link" href="#conditional-variable" title="Direct link to heading">​</a></h5><ul><li>wait_cv： 被一个进程调用, 以等待断言 Pc 被满足后该进程可恢复执行. 进程挂在该条件变量上等待时, 不被认为是占用了管程</li><li>signal_cv：被一个进程调用, 以指出断言 Pc 现在为真, 从而可以唤醒等待断言 Pc 被满足的进程继续执行</li><li>信号量 sem: 用于让发出 wait_cv 操作的等待某个条件 C 为真的进程睡眠, 而让发出 signal_cv 操作的进程通过这个 sem 来唤醒睡眠的进程</li><li>count: 表示等在这个条件变量上的睡眠进程的个数</li><li>owner: 表示此条件变量的宿主是哪个管程</li></ul><div class="codeBlockContainer_I0IT language-cpp theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-cpp codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">condvar</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// the sem semaphore is used to down the waiting proc,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// and the signaling proc should up the waiting</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">semaphore_t sem</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">proc </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// the number of waiters on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">condvar monitor_t </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> owner</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// the owner(monitor) of this conditional variable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> condvar_t</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="文件系统">文件系统<a class="hash-link" href="#文件系统" title="Direct link to heading">​</a></h2><p>File System:</p><ul><li>分配文件磁盘空间: 分配与管理</li><li>管理文件集合: 定位, 命名, 文件系统结构</li><li>数据可靠和安全: 持久化保存, 防止数据丢失(系统崩溃时)</li><li>基本操作单位: 数据块</li><li>文件访问模式: 顺序访问/随机访问/索引访问</li><li>文件系统种类: 磁盘/数据库/日志/网络/分布式/虚拟文件系统</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="文件组成">文件组成<a class="hash-link" href="#文件组成" title="Direct link to heading">​</a></h3><ul><li>文件头: 文件属性(名称/类型/大小/权限/路径/创建者/创建时间/最近修改时间)</li><li>文件头: 文件存储位置与顺序</li><li>文件体: 实际字节序列</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="文件系统基本数据结构">文件系统基本数据结构<a class="hash-link" href="#文件系统基本数据结构" title="Direct link to heading">​</a></h3><p>Super Block -&gt; Directory Entry -&gt; vnode/inode</p><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="文件卷控制块">文件卷控制块<a class="hash-link" href="#文件卷控制块" title="Direct link to heading">​</a></h4><p>Super Block:</p><ul><li>每个文件系统只有一个控制块</li><li>描述该文件系统全局信息: 数据块(大小等信息), 空余块信息, 文件指针/引用计数</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="目录项">目录项<a class="hash-link" href="#目录项" title="Direct link to heading">​</a></h4><p>Directory Entry:</p><ul><li>目录是一类特殊的文件: 其内容为文件索引表(文件名/文件指针), 内部采取哈希表存储</li><li>目录与文件构成树状结构</li><li>每个目录项属于一个目录, 一个目录可有多个目录项</li><li>保存目录相关信息: 指向文件控制块, 父目录/子目录信息</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="文件控制块">文件控制块<a class="hash-link" href="#文件控制块" title="Direct link to heading">​</a></h4><p>vnode/inode:</p><ul><li>每个文件有一个文件控制块</li><li>保存该文件详细信息: 访问权限, 所属者/组, 文件大小, 数据块位置(索引)</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="文件描述符">文件描述符<a class="hash-link" href="#文件描述符" title="Direct link to heading">​</a></h4><p>操作系统在打开文件表中维护的打开文件状态与信息:</p><ul><li>文件指针: 最近一次读写位置</li><li>文件打开计数(引用计数): 引用计数为 0 时, 回收相关资源</li><li>文件磁盘位置</li><li>访问权限</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="打开文件表">打开文件表<a class="hash-link" href="#打开文件表" title="Direct link to heading">​</a></h4><ul><li>系统打开文件表: 保存文件描述符</li><li>进程打开文件表: 指向系统打开文件表某项, 并附加额外信息</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="文件分配">文件分配<a class="hash-link" href="#文件分配" title="Direct link to heading">​</a></h3><ul><li>分配方式: 连续分配, 琏式分配, 索引分配</li><li>琏式索引分配: 琏式链接多个索引块</li><li>多级索引分配: 索引分配 + 多级琏式索引块</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="空闲空间管理">空闲空间管理<a class="hash-link" href="#空闲空间管理" title="Direct link to heading">​</a></h3><ul><li>bit 位图, 链表, 琏式索引: 保存空闲数据块位置与顺序</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="冗余磁盘阵列">冗余磁盘阵列<a class="hash-link" href="#冗余磁盘阵列" title="Direct link to heading">​</a></h3><p>Redundant Array of Inexpensive Disks (RAID):</p><ul><li>RAID-0: 磁盘条带化</li><li>RAID-1: 磁盘镜像(冗余拷贝), 提高可靠性</li><li>RAID-4: 带奇偶校验(校验和)的磁盘条带化, 提高可靠性</li><li>RAID-5: 带分布式奇偶校验的磁盘条带化, 减少校验和所在物理磁盘的读写压力</li><li>RAID-6: 每组条带块有两个冗余块, 可以检查到 2 个磁盘错误</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="fs-实现">FS 实现<a class="hash-link" href="#fs-实现" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="fs-mount">FS Mount<a class="hash-link" href="#fs-mount" title="Direct link to heading">​</a></h4><p><code>sfs_do_mount</code>函数中:</p><ul><li>完成了加载位于硬盘上的 SFS 文件系统的超级块 superblock 和 freemap 的工作 l</li><li>在内存中有了 SFS 文件系统的全局信息</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="fs-index">FS Index<a class="hash-link" href="#fs-index" title="Direct link to heading">​</a></h4><ul><li>对于普通文件，索引值指向的 block 中保存的是文件中的数据</li><li>对于目录，索引值指向的数据保存的是目录下所有的文件名以及对应的索引节点所在的索引块（磁盘块）所形成的数组</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="fs-node">FS Node<a class="hash-link" href="#fs-node" title="Direct link to heading">​</a></h4><p>内存 inode 包含了 SFS 的硬盘 inode 信息, 而且还增加了其他一些信息, 这属于是便于进行是判断否改写、互斥操作、回收和快速地定位等作用.
一个内存 inode 是在打开一个文件后才创建的, 如果关机则相关信息都会消失.
而硬盘 inode 的内容是保存在硬盘中的, 只是在进程需要时才被读入到内存中, 用于访问文件或目录的具体内容数据.</p><div class="codeBlockContainer_I0IT language-cpp theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-cpp codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">inode</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">union</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//包含不同文件系统特定inode信息的union成员变量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">device</span><span class="token plain"> __device_info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//设备文件系统内存inode信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">sfs_inode</span><span class="token plain"> __sfs_inode_info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//SFS文件系统内存inode信息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> in_info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inode_type_device_info </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x1234</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inode_type_sfs_inode_info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> in_type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//此inode所属文件系统类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    atomic_t ref_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//此inode的引用计数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    atomic_t open_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//打开此inode对应文件的个数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">fs</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">in_fs</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//抽象的文件系统，包含访问文件系统的函数指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">inode_ops</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">in_ops</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">//抽象的inode操作，包含访问inode的函数指针</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><div class="codeBlockContainer_I0IT language-cpp theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-cpp codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">inode_ops</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> vop_magic</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vop_open</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">inode</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> open_flags</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vop_close</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">inode</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vop_read</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">inode</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">iobuf</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">iob</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vop_write</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">inode</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">iobuf</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">iob</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vop_getdirentry</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">inode</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">iobuf</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">iob</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vop_create</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">inode</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> excl</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">inode</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">node_store</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vop_lookup</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">inode</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">inode</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">node_store</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ……</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="device">Device<a class="hash-link" href="#device" title="Direct link to heading">​</a></h4><p>利用 <code>vfs_dev_t</code> 数据结构，
就可以让文件系统通过一个链接 <code>vfs_dev_t</code> 结构的双向链表找到 device 对应的 inode 数据结构，
一个 inode 节点的成员变量 in_type 的值是 0x1234，
则此 inode 的成员变量 in_info 将成为一个 device 结构。
这样 inode 就和一个设备建立了联系，这个 inode 就是一个设备文件</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="elf-file-format">ELF File Format<a class="hash-link" href="#elf-file-format" title="Direct link to heading">​</a></h3><div class="codeBlockContainer_I0IT language-cpp theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-cpp codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;common.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdlib.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;elf.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">exec_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">strtab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> Elf32_Sym </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">symtab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> nr_symtab_entry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">load_elf_tables</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> argc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">Assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">argc </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;run NEMU with format &#x27;nemu [program]&#x27;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  exec_file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> argv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  FILE </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">fp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">exec_file</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;rb&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">Assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Can not open &#x27;%s&#x27;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exec_file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">uint8_t</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Elf32_Ehdr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Elf32_Ehdr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* The first several bytes contain the ELF header. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Elf32_Ehdr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">elf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> magic</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ELFMAG0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ELFMAG1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ELFMAG2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ELFMAG3</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* Check ELF header */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">memcmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_ident</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> magic</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// magic number</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_ident</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">EI_CLASS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> ELFCLASS32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 32-bit architecture</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_ident</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">EI_DATA</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> ELFDATA2LSB</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// little-endian</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_ident</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">EI_VERSION</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> EV_CURRENT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// current version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_ident</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">EI_OSABI</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> ELFOSABI_SYSV </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// UNIX System V ABI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_ident</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">EI_OSABI</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> ELFOSABI_LINUX</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// UNIX - GNU</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_ident</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">EI_ABIVERSION</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// should be 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> ET_EXEC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// executable file</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_machine </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> EM_386</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Intel 80386 architecture</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_version </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> EV_CURRENT</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// current version</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* Load symbol table and string table for future use */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* Load section header table */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">uint32_t</span><span class="token plain"> sh_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_shentsize </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_shnum</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Elf32_Shdr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sh </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sh_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">fseek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_shoff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SEEK_SET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sh</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sh_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/* Load section header string table */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">section_header_string_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sh</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_shstrndx</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">fseek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sh</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_shstrndx</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_offset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SEEK_SET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">section_header_string_table  sh</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_shstrndx</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> elf</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">e_shnum</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sh</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> SHT_SYMTAB </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">strcmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">section_header_string_table </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> sh</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.symtab&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">/* Load symbol table from exec_file */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      symtab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sh</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">fseek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sh</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_offset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SEEK_SET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">symtab</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sh</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      nr_symtab_entry </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sh</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_size </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">symtab</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sh</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> SHT_STRTAB </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">strcmp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">section_header_string_table </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> sh</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.strtab&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">/* Load string table from exec_file */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      strtab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">malloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sh</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">fseek</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sh</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_offset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">SEEK_SET</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fread</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">strtab</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sh</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sh_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ret </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">section_header_string_table </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">assert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">strtab </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> symtab </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">fclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="设备管理详解">设备管理详解<a class="hash-link" href="#设备管理详解" title="Direct link to heading">​</a></h2><ul><li>CPU 一般都是通过寄存器的形式来访问外部设备</li><li>外设的寄存器通常包括控制寄存器、状态寄存器与数据寄存器三类, 分别用于发送命令/读取状态/读写数据.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="cga-ega-and-chromatext-video-buffer">CGA EGA and ChromaText Video Buffer<a class="hash-link" href="#cga-ega-and-chromatext-video-buffer" title="Direct link to heading">​</a></h3><p>在内存的低 1MB 中, 有许多地址被映射至外部设备, 其中就包含文字显示模块(显卡控制显示器):</p><ul><li>从 0xB8000 开始, 每 2 个字节表示屏幕上显示的一个字符(80 x 25)</li><li>前一个字节为 字符 ASCII 码, 后一个字节为
字符颜色和属性的控制信息
(back_twinkle, back_r, back_g, back_b, front_light, front_r, front_g, front_b)</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="input-and-output">Input and Output<a class="hash-link" href="#input-and-output" title="Direct link to heading">​</a></h3><p>调用 <code>io_delay()</code> 函数: 对于一些老式总线的外部设备, 读写 I/O 端口的速度若过快就容易出现丢失数据的现象</p><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="实践">实践<a class="hash-link" href="#实践" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="工具">工具<a class="hash-link" href="#工具" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="bochs">Bochs<a class="hash-link" href="#bochs" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="installation">Installation<a class="hash-link" href="#installation" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">wget</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"> http://sourceforge.net/projects/bochs/files/bochs/2.5.1/bochs-2.5.1.tar.gz/download</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"> -O bochs.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> -xvfz bochs.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> bochs-2.5.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./configure --enable-debugger --enable-debugger-gui --enable-disasm --with-x --with-term</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">make</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> ./bochs /usr/bin/bochs-dbg</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="config">Config<a class="hash-link" href="#config" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># BIOS与VGA镜像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">romimage: </span><span class="token assign-left variable" style="color:#36acaa">file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/share/bochs/BIOS-bochs-latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vgaromimage: </span><span class="token assign-left variable" style="color:#36acaa">file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/usr/share/bochs/VGABIOS-lgpl-latest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 内存大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">megs: </span><span class="token number" style="color:#36acaa">128</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 软盘镜像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">floppya: </span><span class="token assign-left variable" style="color:#36acaa">1_44</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">bin/kernel.images, </span><span class="token assign-left variable" style="color:#36acaa">status</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">inserted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 硬盘镜像</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ata0-master: </span><span class="token assign-left variable" style="color:#36acaa">type</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">disk, </span><span class="token assign-left variable" style="color:#36acaa">path</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;bin/rootfs.images&quot;</span><span class="token plain">,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">mode</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">flat, </span><span class="token assign-left variable" style="color:#36acaa">cylinders</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">heads</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">16</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">spt</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">63</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 引导方式(软盘)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">boot: a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 日志输出</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log: .bochsout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">panic: </span><span class="token assign-left variable" style="color:#36acaa">action</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ask</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">error: </span><span class="token assign-left variable" style="color:#36acaa">action</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">report</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">info: </span><span class="token assign-left variable" style="color:#36acaa">action</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">report</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">debug: </span><span class="token assign-left variable" style="color:#36acaa">action</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ignore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 杂项</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vga_update_interval: </span><span class="token number" style="color:#36acaa">300000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keyboard_serial_delay: </span><span class="token number" style="color:#36acaa">250</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keyboard_paste_delay: </span><span class="token number" style="color:#36acaa">100000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mouse: </span><span class="token assign-left variable" style="color:#36acaa">enabled</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private_colormap: </span><span class="token assign-left variable" style="color:#36acaa">enabled</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fullscreen: </span><span class="token assign-left variable" style="color:#36acaa">enabled</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">screenmode: </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;sample&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keyboard_mapping: </span><span class="token assign-left variable" style="color:#36acaa">enabled</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, </span><span class="token assign-left variable" style="color:#36acaa">map</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keyboard_type: at</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 符号表(调试用)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">debug_symbols: </span><span class="token assign-left variable" style="color:#36acaa">file</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">main.sym</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 键盘类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keyboard_type: at</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="run">Run<a class="hash-link" href="#run" title="Direct link to heading">​</a></h5><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">bochs -q -f .bochsrc</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><ul><li>b,vb,lb 分别为物理地址、虚拟地址、逻辑地址设置断点</li><li>c 持续执行，直到遇到断点或者错误</li><li>n 下一步执行</li><li>step 单步执行</li><li>r 显示当前寄存器的值</li><li>sreg 显示当前的段寄存器的值</li><li>info gdt, info idt, info tss, info tab 分别显示当前的 GDT、IDT、TSS、页表信息</li><li>print-stack 打印当前栈顶的值</li><li>help 显示帮助</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="gnu-ld">GNU ld<a class="hash-link" href="#gnu-ld" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT language-cpp theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-cpp codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">ENTRY</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kmain</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SECTIONS </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __bios__ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xa0000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> # 绑定BIOS保留内存的地址到__bios__</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vgamem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xb8000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> # 绑定vga缓冲区的地址到符号vgamem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text </span><span class="token number" style="color:#36acaa">0x100000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> # 内核二进制镜像中的</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text段</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Section</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">，从</span><span class="token number" style="color:#36acaa">0x100000</span><span class="token plain">开始</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __kbegin__ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> # 内核镜像的开始地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __code__ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">o</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">o</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> # 将bin</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">entry</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">o中的</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text段安排到内核镜像的最前方</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4096</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> # </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">text段按</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">kb对齐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __data__ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rodata</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4096</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bss </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        __bss__ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bss</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ALIGN</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4096</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    __kend__ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> # 内核镜像的结束地址</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="memory-management-tools">Memory Management Tools<a class="hash-link" href="#memory-management-tools" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="perf">perf<a class="hash-link" href="#perf" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="trace">trace<a class="hash-link" href="#trace" title="Direct link to heading">​</a></h3><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="vmstat">vmstat<a class="hash-link" href="#vmstat" title="Direct link to heading">​</a></h3><p>check usage of virtual memory and swap region</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">vmstat</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="pmap">pmap<a class="hash-link" href="#pmap" title="Direct link to heading">​</a></h3><p>check detailed usage of memory</p><div class="codeBlockContainer_I0IT language-bash theme-code-block"><div class="codeBlockContent_wNvx" style="color:#393A34;background-color:#f6f8fa"><pre tabindex="0" class="prism-code language-bash codeBlock_jd64 thin-scrollbar"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#393A34"><span class="token plain">pmap PID</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" title="Copy" class="copyButton_eDfN clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="memory-hot-plug">Memory Hot Plug<a class="hash-link" href="#memory-hot-plug" title="Direct link to heading">​</a></h3><ul><li><a href="http://www.kernel.org/doc/Documentation/memory-hotplug.txt" target="_blank" rel="noopener noreferrer">User Guide</a></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="tcmalloc">TCMalloc<a class="hash-link" href="#tcmalloc" title="Direct link to heading">​</a></h3><p>Google TCMalloc</p><h3 class="anchor anchorWithHideOnScrollNavbar_R0VQ" id="oprofile">Oprofile<a class="hash-link" href="#oprofile" title="Direct link to heading">​</a></h3><ul><li><a href="http://oprofile.sourceforge.net" target="_blank" rel="noopener noreferrer">User Guide</a></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/awesome-notes/tags/cs">CS</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/awesome-notes/tags/system">System</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/awesome-notes/tags/os">OS</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/sabertazimi/awesome-notes/edit/main/notes/computerScience/operatingSystems/operatingSystemsBasicNotes.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_foO9"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-04-06T13:08:59.000Z">4/6/2022</time></b> by <b>sabertazimi</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/awesome-notes/computerScience/operatingSystems/CSAPP"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Computer Systems: A Programmer&#x27;s Perspective Basic Notes</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/awesome-notes/computerScience/virtualization/virtualBasicNotes"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Virtualization Basic Notes</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_cNA8 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#os-definition" class="table-of-contents__link toc-highlight">OS Definition</a></li><li><a href="#gcc-内联汇编" class="table-of-contents__link toc-highlight">GCC 内联汇编</a></li><li><a href="#基本概念" class="table-of-contents__link toc-highlight">基本概念</a><ul><li><a href="#操作系统的特性" class="table-of-contents__link toc-highlight">操作系统的特性</a></li><li><a href="#操作系统的资源管理功能" class="table-of-contents__link toc-highlight">操作系统的资源管理功能</a></li><li><a href="#操作系统的演变" class="table-of-contents__link toc-highlight">操作系统的演变</a></li><li><a href="#操作系统虚拟机" class="table-of-contents__link toc-highlight">操作系统虚拟机</a></li><li><a href="#操作系统的组织结构" class="table-of-contents__link toc-highlight">操作系统的组织结构</a></li><li><a href="#并发" class="table-of-contents__link toc-highlight">并发</a></li></ul></li><li><a href="#启动" class="table-of-contents__link toc-highlight">启动</a><ul><li><a href="#bios" class="table-of-contents__link toc-highlight">BIOS</a></li><li><a href="#启动顺序" class="table-of-contents__link toc-highlight">启动顺序</a></li></ul></li><li><a href="#物理内存管理" class="table-of-contents__link toc-highlight">物理内存管理</a><ul><li><a href="#boot-loader-探测机器内存分布" class="table-of-contents__link toc-highlight">Boot Loader 探测机器内存分布</a></li><li><a href="#boot-loader-基本概念" class="table-of-contents__link toc-highlight">Boot Loader 基本概念</a></li><li><a href="#连续内存分配" class="table-of-contents__link toc-highlight">连续内存分配</a></li><li><a href="#非连续内存分配" class="table-of-contents__link toc-highlight">非连续内存分配</a></li><li><a href="#内存的特权级" class="table-of-contents__link toc-highlight">内存的特权级</a></li></ul></li><li><a href="#虚拟内存管理" class="table-of-contents__link toc-highlight">虚拟内存管理</a><ul><li><a href="#page-fault" class="table-of-contents__link toc-highlight">Page Fault</a></li><li><a href="#覆盖与交换" class="table-of-contents__link toc-highlight">覆盖与交换</a></li><li><a href="#虚拟页式存储管理" class="table-of-contents__link toc-highlight">虚拟页式存储管理</a></li></ul></li><li><a href="#中断" class="table-of-contents__link toc-highlight">中断</a><ul><li><a href="#中断进入" class="table-of-contents__link toc-highlight">中断进入</a></li><li><a href="#中断实现" class="table-of-contents__link toc-highlight">中断实现</a></li><li><a href="#系统调用" class="table-of-contents__link toc-highlight">系统调用</a></li></ul></li><li><a href="#进程" class="table-of-contents__link toc-highlight">进程</a><ul><li><a href="#进程特权级" class="table-of-contents__link toc-highlight">进程特权级</a></li><li><a href="#进程状态与生命周期" class="table-of-contents__link toc-highlight">进程状态与生命周期</a></li><li><a href="#进程通信" class="table-of-contents__link toc-highlight">进程通信</a></li><li><a href="#线程" class="table-of-contents__link toc-highlight">线程</a></li><li><a href="#内核线程与用户进程" class="table-of-contents__link toc-highlight">内核线程与用户进程</a></li><li><a href="#process-实现" class="table-of-contents__link toc-highlight">Process 实现</a></li></ul></li><li><a href="#处理机调度" class="table-of-contents__link toc-highlight">处理机调度</a><ul><li><a href="#调度时机" class="table-of-contents__link toc-highlight">调度时机</a></li><li><a href="#调度策略" class="table-of-contents__link toc-highlight">调度策略</a></li></ul></li><li><a href="#同步互斥" class="table-of-contents__link toc-highlight">同步互斥</a><ul><li><a href="#临界区的访问原则" class="table-of-contents__link toc-highlight">临界区的访问原则</a></li><li><a href="#基于软件方法的同步互斥" class="table-of-contents__link toc-highlight">基于软件方法的同步互斥</a></li><li><a href="#高级抽象的同步互斥" class="table-of-contents__link toc-highlight">高级抽象的同步互斥</a></li><li><a href="#死锁" class="table-of-contents__link toc-highlight">死锁</a></li><li><a href="#mutex-实现" class="table-of-contents__link toc-highlight">Mutex 实现</a></li></ul></li><li><a href="#文件系统" class="table-of-contents__link toc-highlight">文件系统</a><ul><li><a href="#文件组成" class="table-of-contents__link toc-highlight">文件组成</a></li><li><a href="#文件系统基本数据结构" class="table-of-contents__link toc-highlight">文件系统基本数据结构</a></li><li><a href="#文件分配" class="table-of-contents__link toc-highlight">文件分配</a></li><li><a href="#空闲空间管理" class="table-of-contents__link toc-highlight">空闲空间管理</a></li><li><a href="#冗余磁盘阵列" class="table-of-contents__link toc-highlight">冗余磁盘阵列</a></li><li><a href="#fs-实现" class="table-of-contents__link toc-highlight">FS 实现</a></li><li><a href="#elf-file-format" class="table-of-contents__link toc-highlight">ELF File Format</a></li></ul></li><li><a href="#设备管理详解" class="table-of-contents__link toc-highlight">设备管理详解</a><ul><li><a href="#cga-ega-and-chromatext-video-buffer" class="table-of-contents__link toc-highlight">CGA EGA and ChromaText Video Buffer</a></li><li><a href="#input-and-output" class="table-of-contents__link toc-highlight">Input and Output</a></li></ul></li><li><a href="#实践" class="table-of-contents__link toc-highlight">实践</a><ul><li><a href="#工具" class="table-of-contents__link toc-highlight">工具</a></li></ul></li><li><a href="#memory-management-tools" class="table-of-contents__link toc-highlight">Memory Management Tools</a><ul><li><a href="#perf" class="table-of-contents__link toc-highlight">perf</a></li><li><a href="#trace" class="table-of-contents__link toc-highlight">trace</a></li><li><a href="#vmstat" class="table-of-contents__link toc-highlight">vmstat</a></li><li><a href="#pmap" class="table-of-contents__link toc-highlight">pmap</a></li><li><a href="#memory-hot-plug" class="table-of-contents__link toc-highlight">Memory Hot Plug</a></li><li><a href="#tcmalloc" class="table-of-contents__link toc-highlight">TCMalloc</a></li><li><a href="#oprofile" class="table-of-contents__link toc-highlight">Oprofile</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Notes</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/awesome-notes/intro">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/awesome-notes/computerScience/algorithms/algorithmsBasicNotes">Computer Science</a></li><li class="footer__item"><a class="footer__link-item" href="/awesome-notes/programming/android/androidBasicNotes">Programming</a></li><li class="footer__item"><a class="footer__link-item" href="/awesome-notes/language/assembly/assemblyBasicNotes">Language</a></li><li class="footer__item"><a class="footer__link-item" href="/awesome-notes/web/angular/angularBasicNotes">Web</a></li></ul></div><div class="col footer__col"><div class="footer__title">Social Media</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/sabertazimi" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/sabertazimi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://facebook.com/sabertazimi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://weibo.com/sabertazimi" target="_blank" rel="noopener noreferrer" class="footer__link-item">Weibo<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="mailto:sabertazimi@gmail.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Find More</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/sabertazimi/awesome-web" target="_blank" rel="noopener noreferrer" class="footer__link-item">Awesome Web<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/sabertazimi/bod" target="_blank" rel="noopener noreferrer" class="footer__link-item">Bod CLI<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/sabertazimi/dragon-zsh-theme" target="_blank" rel="noopener noreferrer" class="footer__link-item">Dragon ZSH Theme<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/sabertazimi/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gatsby Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/sabertazimi/boilerplate" target="_blank" rel="noopener noreferrer" class="footer__link-item">Minimal Boilerplate<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Sabertazimi.</div></div></div></footer></div>
<script src="/awesome-notes/assets/js/runtime~main.d7ce8a84.js"></script>
<script src="/awesome-notes/assets/js/main.12b2598d.js"></script>
</body>
</html>